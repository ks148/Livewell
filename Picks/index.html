<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Livewell â€“ Picks</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{font-family:system-ui;margin:20px;background:#f4f6f9}
.card{background:#fff;padding:16px;border-radius:14px;margin-bottom:16px;box-shadow:0 2px 8px rgba(0,0,0,.05)}
.row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
button{padding:8px 14px;border-radius:10px;border:1px solid #d1d5db;font-weight:700;cursor:pointer}
button:disabled{opacity:.5;cursor:not-allowed}
.primary{background:#2563eb;color:#fff;border-color:#2563eb}
select{padding:6px 10px;border-radius:8px;border:1px solid #d1d5db;font-weight:600}
table{width:100%;border-collapse:collapse}
th,td{padding:8px;border-bottom:1px solid #e5e7eb;text-align:left}
th{background:#f1f5f9}
.mono{font-family:monospace}
</style>
</head>

<body>

<h1>Picks</h1>

<div class="card">
  <div class="row">
    <label>Pick FROM:</label>
    <select id="fromLoc">
      <option value="warehouse" selected>Warehouse-66</option>
      <option value="container">Container - PLY</option>
      <option value="green">Green Harbor</option>
      <option value="plymouth">Plymouth</option>
    </select>

    <label>Pick TO:</label>
    <select id="toLoc">
      <option value="plymouth">Plymouth</option>
      <option value="green">Green Harbor</option>
      <option value="both">Both</option>
    </select>

    <button class="primary" onclick="buildPick()">Build Pick</button>
    <button onclick="downloadPickerCSV()" id="pickerBtn" disabled>Picker</button>
    <button onclick="downloadShopifyCSV()" id="shopifyBtn" disabled>Shopify Upload</button>
  </div>
</div>

<div class="card">
  <table>
    <thead>
      <tr id="tableHead"></tr>
    </thead>
    <tbody id="results"></tbody>
  </table>
</div>

<script>

const CSV_URL = '../pickle-data.csv';

const COL_BARCODE = 'Variant Barcode';
const COL_TITLE = 'Title';
const COL_WH_BIN = 'Variant Metafield: custom.wh_bin [single_line_text_field]';
const SKU_CANDIDATES = ['Variant SKU','SKU','sku'];

const COL_WH_AV = 'Inventory Available: Warehouse-66';
const COL_CONT_AV = 'Inventory Available: Container - PLY';
const COL_PLY_ON = 'Inventory Available: Plymouth';
const COL_GH_ON = 'Inventory Available: Green Harbor';

const COL_PLY_MIN = 'Variant Metafield: custom.minply [number_integer]';
const COL_PLY_MAX = 'Variant Metafield: custom.maxply [number_integer]';
const COL_GH_MIN = 'Variant Metafield: custom.mingh [number_integer]';
const COL_GH_MAX = 'Variant Metafield: custom.maxgh [number_integer]';

let rows = [];
let lastPick = [];
let meta = null;

function n(v){
  const num = Number(String(v ?? '').trim());
  return Number.isFinite(num) ? Math.floor(num) : 0;
}

function need(on,min,max){
  if(!(on < min)) return 0;
  return Math.max(max - on, 0);
}

function getSku(row){
  for(const k of SKU_CANDIDATES){
    if(k in row && row[k]) return row[k].trim();
  }
  return '';
}

function pad(x){ return String(x).padStart(2,'0'); }

function nowStamp(){
  const d = new Date();
  return {
    date: `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`,
    time: `${pad(d.getHours())}${pad(d.getMinutes())}`
  };
}

function locCode(val){
  if(val === 'warehouse') return 'WH';
  if(val === 'container') return 'PLYMCon';
  if(val === 'plymouth') return 'PLY';
  if(val === 'green') return 'GH';
  return val.toUpperCase();
}

async function loadCSV(){
  const res = await fetch(CSV_URL + '?v=' + Date.now());
  const text = await res.text();
  const lines = text.trim().split('\n').map(r=>r.split(','));
  const headers = lines[0];
  rows = lines.slice(1).map(r=>{
    const obj={};
    headers.forEach((h,i)=>obj[h.trim()]=r[i]?.trim());
    return obj;
  });
}

function renderHead(to){
  let h = `<th>Barcode</th><th>Title</th><th>WH Bin</th><th>WH Avail</th>`;
  if(to==='plymouth') h+=`<th>PLY</th>`;
  else if(to==='green') h+=`<th>GH</th>`;
  else h+=`<th>PLY</th><th>GH</th>`;
  document.getElementById('tableHead').innerHTML = h;
}

function buildPick(){
  const from = document.getElementById('fromLoc').value;
  const to = document.getElementById('toLoc').value;

  renderHead(to);
  lastPick = [];
  document.getElementById('results').innerHTML='';

  rows.forEach(r=>{
    const barcode=r[COL_BARCODE];
    const title=r[COL_TITLE];
    if(!barcode && !title) return;

    const wh=n(r[COL_WH_AV]);
    if(wh<=0) return;

    const plyNeed=need(n(r[COL_PLY_ON]),n(r[COL_PLY_MIN]),n(r[COL_PLY_MAX]));
    const ghNeed=need(n(r[COL_GH_ON]),n(r[COL_GH_MIN]),n(r[COL_GH_MAX]));

    let plyPick=0,ghPick=0;
    if(to==='plymouth') plyPick=Math.min(plyNeed,wh);
    else if(to==='green') ghPick=Math.min(ghNeed,wh);
    else{
      plyPick=Math.min(plyNeed,wh);
      ghPick=Math.min(ghNeed,wh-plyPick);
    }

    if(plyPick<=0 && ghPick<=0) return;

    lastPick.push({r,plyPick,ghPick,to,wh});
  });

  const tbody=document.getElementById('results');
  lastPick.forEach(p=>{
    const tr=document.createElement('tr');
    let row=`<td class="mono">${p.r[COL_BARCODE]}</td>
             <td>${p.r[COL_TITLE]}</td>
             <td>${p.r[COL_WH_BIN]||''}</td>
             <td>${p.wh}</td>`;
    if(p.to==='plymouth') row+=`<td>${p.plyPick}</td>`;
    else if(p.to==='green') row+=`<td>${p.ghPick}</td>`;
    else row+=`<td>${p.plyPick}</td><td>${p.ghPick}</td>`;
    tr.innerHTML=row;
    tbody.appendChild(tr);
  });

  if(!lastPick.length) return;

  const stamp=nowStamp();
  meta={
    from:locCode(from),
    to:locCode(to),
    date:stamp.date,
    time:stamp.time,
    toSelection:to
  };

  document.getElementById('pickerBtn').disabled=false;
  document.getElementById('shopifyBtn').disabled=false;
}

function pickerFilename(){
  return `${meta.from}_to_${meta.to}_${meta.date}_${meta.time}_PICK.csv`;
}

function uploadFilename(dest){
  return `${meta.from}_to_${dest}_${meta.date}_${meta.time}_UPLOAD.csv`;
}

function downloadPickerCSV(){
  if(!meta) return;

  let csv="";
  csv+=`FROM: ${meta.from}\n`;
  csv+=`TO: ${meta.to}\n`;
  csv+=`Generated: ${meta.date} ${meta.time}\n`;
  csv+=`Shopify Transfer #: ______________________\n\n`;

  let header="Barcode,SKU,Title,WH Bin,WH Available";
  if(meta.toSelection==='plymouth') header+=",PLY\n";
  else if(meta.toSelection==='green') header+=",GH\n";
  else header+=",PLY,GH\n";
  csv+=header;

  lastPick.forEach(p=>{
    const sku=getSku(p.r);
    let line=`"${p.r[COL_BARCODE]}",${sku},"${p.r[COL_TITLE]}",${p.r[COL_WH_BIN]||''},${p.wh}`;
    if(p.to==='plymouth') line+=`,`+p.plyPick;
    else if(p.to==='green') line+=`,`+p.ghPick;
    else line+=`,`+p.plyPick+`,`+p.ghPick;
    csv+=line+"\n";
  });

  downloadText(pickerFilename(),csv);
}

function buildUpload(dest){
  let csv="sku,barcode,quantity\n";
  lastPick.forEach(p=>{
    const sku=getSku(p.r);
    const barcode=p.r[COL_BARCODE];
    const qty=(dest==='plymouth')?p.plyPick:p.ghPick;
    if(qty>0) csv+=`${sku},${barcode},${qty}\n`;
  });
  return csv;
}

function downloadShopifyCSV(){
  if(!meta) return;

  if(meta.toSelection==='plymouth'){
    downloadText(uploadFilename('PLY'),buildUpload('plymouth'));
  }
  else if(meta.toSelection==='green'){
    downloadText(uploadFilename('GH'),buildUpload('green'));
  }
  else{
    downloadText(uploadFilename('PLY'),buildUpload('plymouth'));
    downloadText(uploadFilename('GH'),buildUpload('green'));
  }
}

function downloadText(name,text){
  const blob=new Blob([text],{type:'text/csv'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;
  a.download=name;
  a.click();
  URL.revokeObjectURL(url);
}

loadCSV();

</script>

</body>
</html>
