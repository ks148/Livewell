<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Livewell ‚Äì Picks</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{font-family:system-ui;margin:20px;background:#f4f6f9}

/* NAV */
.topnav{
  position:sticky; top:0; z-index:50;
  background:#fff;
  border:1px solid #e5e7eb;
  border-radius:14px;
  padding:10px;
  margin-bottom:16px;
  box-shadow:0 2px 10px rgba(0,0,0,.05);
}
.topnav .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.topnav .spacer{flex:1}
.topnav a{text-decoration:none}
.topnav button{
  padding:8px 14px;border-radius:10px;border:1px solid #d1d5db;
  font-weight:700;cursor:pointer;background:#fff;
}
.topnav button.active{
  background:#111827;color:#fff;border-color:#111827;
}

.card{
  background:#fff;
  padding:16px;
  border-radius:14px;
  margin-bottom:16px;
  box-shadow:0 2px 8px rgba(0,0,0,.05)
}

.row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}

button{
  padding:8px 14px;
  border-radius:10px;
  border:1px solid #d1d5db;
  font-weight:700;
  cursor:pointer;
}
button:disabled{opacity:.5; cursor:not-allowed}
.primary{
  background:#2563eb;
  color:#fff;
  border-color:#2563eb;
}

select{
  padding:6px 10px;
  border-radius:8px;
  border:1px solid #d1d5db;
  font-weight:600;
}

table{width:100%;border-collapse:collapse}
th,td{padding:8px;border-bottom:1px solid #e5e7eb;text-align:left}
th{background:#f1f5f9}
.mono{font-family:monospace}
.small{font-size:12px;color:#64748b;font-weight:700}
.warn{background:#fff7ed;border:1px solid #fed7aa;color:#9a3412;padding:10px 12px;border-radius:12px;font-weight:700}

/* Pick header for matching transfer <-> sheet */
.pickHeader{
  display:none;
  padding:12px 14px;
  border:2px solid #0f172a;
  border-radius:14px;
  background:#f8fafc;
  margin-bottom:12px;
}
.pickHeader .title{font-size:18px;font-weight:900}
.pickHeader .grid{display:flex;flex-wrap:wrap;gap:12px;margin-top:8px}
.pickHeader .chip{
  background:#fff;border:1px solid #e5e7eb;border-radius:12px;
  padding:8px 10px;font-weight:800
}
.pickHeader .chip span{font-weight:900}
</style>
</head>

<body>

<!-- NAV (paths assume your folder is literally "Picks") -->
<div class="topnav">
  <div class="row">
    <a href="../index.html"><button>üè† Home</button></a>
    <a href="../Picks/index.html"><button class="active">üìã Picks</button></a>
    <a href="../putaway/index.html"><button>üì¶ Putaway</button></a>
    <a href="../bin/index.html"><button>üìç Bin Lookup</button></a>
    <div class="spacer"></div>
    <div class="small">Ops Tools</div>
  </div>
</div>

<h1>Picks</h1>

<div class="card">
  <div class="row">
    <label>Pick FROM:</label>
    <select id="fromLoc">
      <option value="warehouse" selected>Warehouse-66</option>
      <option value="container">Container - PLY</option>
      <option value="green">Green Harbor</option>
      <option value="plymouth">Plymouth</option>
    </select>

    <label>
      <input type="checkbox" id="fallback" checked>
      WH ‚Üí Container fallback
    </label>

    <label>Pick TO:</label>
    <select id="toLoc">
      <option value="plymouth">Plymouth</option>
      <option value="green">Green Harbor</option>
      <option value="both">Both</option>
    </select>

    <button class="primary" onclick="buildPick()">Build Pick</button>

    <!-- Separated buttons -->
    <button onclick="downloadPickerCSV()" id="pickerBtn" disabled>Picker</button>
    <button onclick="downloadShopifyCSV()" id="shopifyBtn" disabled>Shopify Upload</button>
  </div>

  <div id="loadMsg" style="margin-top:12px;display:none" class="warn"></div>
</div>

<div class="card">
  <!-- Header shown on-screen so you can match pick sheet to transfer -->
  <div id="pickHeader" class="pickHeader">
    <div class="title">LIVEWELL PICK SHEET</div>
    <div class="grid">
      <div class="chip">Transfer #: <span id="ph_transfer"></span></div>
      <div class="chip">From: <span id="ph_from"></span></div>
      <div class="chip">To: <span id="ph_to"></span></div>
      <div class="chip">Created: <span id="ph_date"></span></div>
    </div>
    <div class="small" style="margin-top:8px">
      Use the same Transfer # in Shopify transfer name/notes if possible. Picker CSV includes this header block for printing.
    </div>
  </div>

  <table>
    <thead>
      <tr id="tableHead"></tr>
    </thead>
    <tbody id="results"></tbody>
  </table>
</div>

<script>
/** DATA SOURCE **/
const CSV_URL = '../pickle-data.csv';

/** COLUMN NAMES (must match your Shopify export headers) **/
const COL_BARCODE = 'Variant Barcode';
const COL_TITLE = 'Title';
const COL_WH_BIN = 'Variant Metafield: custom.wh_bin [single_line_text_field]';

// SKU column can vary by export; we‚Äôll try common names
const SKU_CANDIDATES = ['Variant SKU', 'SKU', 'sku', 'variant_sku'];

const COL_WH_AV = 'Inventory Available: Warehouse-66';
const COL_CONT_AV = 'Inventory Available: Container - PLY';
const COL_PLY_ON = 'Inventory Available: Plymouth';
const COL_GH_ON = 'Inventory Available: Green Harbor';

const COL_PLY_MIN = 'Variant Metafield: custom.minply [number_integer]';
const COL_PLY_MAX = 'Variant Metafield: custom.maxply [number_integer]';
const COL_GH_MIN = 'Variant Metafield: custom.mingh [number_integer]';
const COL_GH_MAX = 'Variant Metafield: custom.maxgh [number_integer]';

let rows = [];
let lastPick = []; // { r, whAvailable, plyPick, ghPick, to }
let pickMeta = null; // { transferNum, fromCode, toCode, createdAt, toSelection }

/** STRICT INTEGER PARSER:
 *  - blank => 0
 *  - non-numeric => 0
 *  - decimals => floored
 */
function n(v){
  const s = String(v ?? '').trim();
  if(!s) return 0;
  const num = Number(s);
  return Number.isFinite(num) ? Math.floor(num) : 0;
}

function need(on,min,max){
  if(!(on < min)) return 0;
  return Math.max(max - on, 0);
}

/** Renders table headers based on TO selection */
function renderTableHead(to){
  let h = `
    <th>Barcode</th>
    <th>Title</th>
    <th>WH Bin</th>
    <th>WH Available</th>
  `;

  if(to === 'plymouth'){
    h += `<th>PLY</th>`;
  } else if(to === 'green'){
    h += `<th>GH</th>`;
  } else {
    h += `<th>PLY</th><th>GH</th>`;
  }

  document.getElementById('tableHead').innerHTML = h;
}

/** CSV PARSER (handles quotes + commas correctly) */
function parseCSV(text){
  text = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n');

  const rows = [];
  let row = [];
  let field = '';
  let inQuotes = false;

  for(let i=0;i<text.length;i++){
    const c = text[i];

    if(inQuotes){
      if(c === '"'){
        if(text[i+1] === '"'){
          field += '"';
          i++;
        } else {
          inQuotes = false;
        }
      } else {
        field += c;
      }
    } else {
      if(c === '"'){
        inQuotes = true;
      } else if(c === ','){
        row.push(field);
        field = '';
      } else if(c === '\n'){
        row.push(field);
        field = '';
        if(row.length > 1 || (row.length === 1 && row[0].trim() !== '')){
          rows.push(row);
        }
        row = [];
      } else {
        field += c;
      }
    }
  }

  row.push(field);
  if(row.length > 1 || (row.length === 1 && row[0].trim() !== '')){
    rows.push(row);
  }

  if(!rows.length) return { headers: [], records: [] };

  const headers = rows[0].map(h => String(h ?? '').trim());
  const records = rows.slice(1).map(r => {
    const obj = {};
    headers.forEach((h, idx) => {
      obj[h] = (r[idx] ?? '').trim();
    });
    return obj;
  });

  return { headers, records };
}

/** Load CSV */
async function loadCSV(){
  const msg = document.getElementById('loadMsg');
  msg.style.display = 'none';
  msg.textContent = '';

  const res = await fetch(CSV_URL + '?v=' + Date.now(), { cache: 'no-store' });
  if(!res.ok) throw new Error('Failed to load pickle-data.csv (HTTP ' + res.status + ')');

  const text = await res.text();
  const parsed = parseCSV(text);

  rows = parsed.records;

  const required = [COL_BARCODE, COL_TITLE, COL_WH_AV, COL_CONT_AV, COL_PLY_ON, COL_GH_ON];
  const missing = required.filter(col => !(col in (rows[0] || {})));
  if(missing.length){
    msg.style.display = 'block';
    msg.textContent = 'Warning: pickle-data.csv is missing expected columns. Picks may be wrong. Missing: ' + missing.join(' | ');
  }
}

/** Helpers **/
function pad2(x){ return String(x).padStart(2,'0'); }

function formatDateTime(d){
  return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())} ${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
}

function getLocCode(val){
  // User requested codes:
  // WH for warehouse, PLY for plymouth, GH for Green Harbor, PLYMCon for plymouth container
  if(val === 'warehouse') return 'WH';
  if(val === 'plymouth') return 'PLY';
  if(val === 'green') return 'GH';
  if(val === 'container') return 'PLYMCon';
  return String(val || '').toUpperCase();
}

function getToCode(val){
  if(val === 'plymouth') return 'PLY';
  if(val === 'green') return 'GH';
  if(val === 'both') return 'BOTH';
  return String(val || '').toUpperCase();
}

function makeTransferNumber(){
  // Human readable "Transfer #": YYYYMMDD-HHMM
  const d = new Date();
  const yyyy = d.getFullYear();
  const mm = pad2(d.getMonth()+1);
  const dd = pad2(d.getDate());
  const hh = pad2(d.getHours());
  const mi = pad2(d.getMinutes());
  return `${yyyy}${mm}${dd}-${hh}${mi}`;
}

function setPickHeader(meta){
  const el = document.getElementById('pickHeader');
  el.style.display = 'block';
  document.getElementById('ph_transfer').textContent = meta.transferNum;
  document.getElementById('ph_from').textContent = meta.fromCode;
  document.getElementById('ph_to').textContent = meta.toCode;
  document.getElementById('ph_date').textContent = meta.createdAt;
}

function enableExportButtons(enabled){
  document.getElementById('pickerBtn').disabled = !enabled;
  document.getElementById('shopifyBtn').disabled = !enabled;
}

function getSku(rowObj){
  for(const k of SKU_CANDIDATES){
    if(k in rowObj){
      const v = String(rowObj[k] || '').trim();
      if(v) return v;
    }
  }
  return '';
}

/** CSV building helpers **/
function csvEscape(value){
  const s = String(value ?? '');
  if (/[",\n]/.test(s)) return `"${s.replace(/"/g, '""')}"`;
  return s;
}
function toCsv(lines){
  return lines.map(line => line.map(csvEscape).join(',')).join('\n') + '\n';
}
function downloadText(filename, text){
  const blob = new Blob([text], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  a.click();
  URL.revokeObjectURL(url);
}

/** Build pick list */
function buildPick(){
  const from = document.getElementById('fromLoc').value;
  const to = document.getElementById('toLoc').value;
  const fallback = document.getElementById('fallback').checked;

  const fromCode = getLocCode(from);
  const toCode = getToCode(to);

  renderTableHead(to);

  const tbody = document.getElementById('results');
  tbody.innerHTML = '';
  lastPick = [];
  pickMeta = null;
  enableExportButtons(false);
  document.getElementById('pickHeader').style.display = 'none';

  rows.forEach(r=>{
    const barcode = String(r[COL_BARCODE] || '').trim();
    const title = String(r[COL_TITLE] || '').trim();
    if(!barcode && !title) return;

    const wh = n(r[COL_WH_AV]);
    const cont = n(r[COL_CONT_AV]);

    let whAvailable = 0;

    if(from === 'warehouse' && fallback){
      if(wh > 0) whAvailable = wh;
      else if(cont > 0) whAvailable = cont;
      else return;
    } else {
      whAvailable =
        (from==='warehouse') ? wh :
        (from==='container') ? cont :
        (from==='green') ? n(r[COL_GH_ON]) :
        n(r[COL_PLY_ON]);

      if(whAvailable <= 0) return;
    }

    const plyNeed = need(n(r[COL_PLY_ON]), n(r[COL_PLY_MIN]), n(r[COL_PLY_MAX]));
    const ghNeed  = need(n(r[COL_GH_ON]),  n(r[COL_GH_MIN]),  n(r[COL_GH_MAX]));

    let plyPick = 0;
    let ghPick = 0;

    if(to === 'plymouth'){
      plyPick = Math.min(plyNeed, whAvailable);
    } else if(to === 'green'){
      ghPick = Math.min(ghNeed, whAvailable);
    } else {
      plyPick = Math.min(plyNeed, whAvailable);
      ghPick  = Math.min(ghNeed,  whAvailable - plyPick);
    }

    if(plyPick <= 0 && ghPick <= 0) return;

    const tr = document.createElement('tr');

    let rowHTML = `
      <td class="mono">${barcode}</td>
      <td>${title}</td>
      <td>${(r[COL_WH_BIN]||'')}</td>
      <td>${whAvailable}</td>
    `;

    if(to === 'plymouth'){
      rowHTML += `<td>${plyPick}</td>`;
    } else if(to === 'green'){
      rowHTML += `<td>${ghPick}</td>`;
    } else {
      rowHTML += `<td>${plyPick}</td><td>${ghPick}</td>`;
    }

    tr.innerHTML = rowHTML;
    tbody.appendChild(tr);

    lastPick.push({ r, whAvailable, plyPick, ghPick, to });
  });

  if(!lastPick.length){
    enableExportButtons(false);
    return;
  }

  const d = new Date();
  pickMeta = {
    transferNum: makeTransferNumber(),
    fromCode,
    toCode,
    createdAt: formatDateTime(d),
    toSelection: to
  };

  setPickHeader(pickMeta);
  enableExportButtons(true);
}

/** Human-readable filenames **/
function pickerFilename(){
  // Example: "WH_to_PLY_Transfer_20260218-1015_PICKER.csv"
  return `${pickMeta.fromCode}_to_${pickMeta.toCode}_Transfer_${pickMeta.transferNum}_PICKER.csv`;
}

function shopifyFilename(destCode){
  // Example: "WH_to_PLY_Transfer_20260218-1015_SHOPIFY_UPLOAD.csv"
  return `${pickMeta.fromCode}_to_${destCode}_Transfer_${pickMeta.transferNum}_SHOPIFY_UPLOAD.csv`;
}

/** Build PICKER CSV (printable header block included) */
function buildPickerCsv(){
  const to = lastPick[0].to;

  const lines = [];

  // Printable header block
  lines.push(['LIVEWELL PICK SHEET']);
  lines.push(['Transfer #', pickMeta.transferNum]);
  lines.push(['From', pickMeta.fromCode, 'To', pickMeta.toCode]);
  lines.push(['Created', pickMeta.createdAt]);
  lines.push([]); // blank line

  // Table header
  let header = ['Barcode','SKU','Title','WH Bin','WH Available'];
  if(to === 'plymouth') header.push('PLY');
  else if(to === 'green') header.push('GH');
  else { header.push('PLY'); header.push('GH'); }
  lines.push(header);

  // Data
  lastPick.forEach(p=>{
    const barcode = String(p.r[COL_BARCODE] || '').trim();
    const sku = getSku(p.r);
    const title = String(p.r[COL_TITLE] || '').trim();
    const bin = String(p.r[COL_WH_BIN] || '').trim();

    const row = [
      `="${barcode}"`,  // keep leading zeros in Excel
      sku,
      title,
      bin,
      p.whAvailable
    ];

    if(p.to === 'plymouth') row.push(p.plyPick);
    else if(p.to === 'green') row.push(p.ghPick);
    else { row.push(p.plyPick); row.push(p.ghPick); }

    lines.push(row);
  });

  return toCsv(lines);
}

/** Build SHOPIFY UPLOAD CSV (STRICT: sku, barcode, quantity) */
function buildShopifyCsvForDest(dest){
  // dest: 'plymouth' or 'green'
  const lines = [];
  lines.push(['sku','barcode','quantity']);

  lastPick.forEach(p=>{
    const sku = getSku(p.r);
    const barcode = String(p.r[COL_BARCODE] || '').trim();

    const qty = (dest === 'plymouth') ? p.plyPick : p.ghPick;
    if(!qty || qty <= 0) return;

    lines.push([sku, barcode, qty]);
  });

  return toCsv(lines);
}

/** Button actions **/
function downloadPickerCSV(){
  if(!lastPick.length || !pickMeta) return;
  downloadText(pickerFilename(), buildPickerCsv());
}

function downloadShopifyCSV(){
  if(!lastPick.length || !pickMeta) return;

  const to = lastPick[0].to;

  if(to === 'plymouth'){
    downloadText(shopifyFilename('PLY'), buildShopifyCsvForDest('plymouth'));
  } else if(to === 'green'){
    downloadText(shopifyFilename('GH'), buildShopifyCsvForDest('green'));
  } else {
    // Both -> output TWO Shopify uploads (PLY + GH) sharing the same Transfer #
    downloadText(shopifyFilename('PLY'), buildShopifyCsvForDest('plymouth'));
    downloadText(shopifyFilename('GH'), buildShopifyCsvForDest('green'));
  }
}

// init
loadCSV().catch(err=>{
  const msg = document.getElementById('loadMsg');
  msg.style.display = 'block';
  msg.textContent = (err && err.message) ? err.message : 'Failed to load pickle-data.csv';
});
</script>

</body>
</html>
