<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Livewell ‚Äì Picks</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{font-family:system-ui;margin:20px;background:#f4f6f9}

/* NAV */
.topnav{
  position:sticky; top:0; z-index:50;
  background:#fff;
  border:1px solid #e5e7eb;
  border-radius:14px;
  padding:10px;
  margin-bottom:16px;
  box-shadow:0 2px 10px rgba(0,0,0,.05);
}
.topnav .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.topnav .spacer{flex:1}
.topnav a{text-decoration:none}
.topnav button{
  padding:8px 14px;border-radius:10px;border:1px solid #d1d5db;
  font-weight:700;cursor:pointer;background:#fff;
}
.topnav button.active{
  background:#111827;color:#fff;border-color:#111827;
}

.card{
  background:#fff;
  padding:16px;
  border-radius:14px;
  margin-bottom:16px;
  box-shadow:0 2px 8px rgba(0,0,0,.05)
}

.row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}

button{
  padding:8px 14px;
  border-radius:10px;
  border:1px solid #d1d5db;
  font-weight:700;
  cursor:pointer;
}
.primary{
  background:#2563eb;
  color:#fff;
  border-color:#2563eb;
}

select{
  padding:6px 10px;
  border-radius:8px;
  border:1px solid #d1d5db;
  font-weight:600;
}

table{width:100%;border-collapse:collapse}
th,td{padding:8px;border-bottom:1px solid #e5e7eb;text-align:left}
th{background:#f1f5f9}
.mono{font-family:monospace}
.small{font-size:12px;color:#64748b;font-weight:700}
.warn{background:#fff7ed;border:1px solid #fed7aa;color:#9a3412;padding:10px 12px;border-radius:12px;font-weight:700}
</style>
</head>

<body>

<!-- NAV (paths assume your folder is literally "Picks") -->
<div class="topnav">
  <div class="row">
    <a href="../index.html"><button>üè† Home</button></a>
    <a href="../Picks/index.html"><button class="active">üìã Picks</button></a>
    <a href="../putaway/index.html"><button>üì¶ Putaway</button></a>
    <a href="../bin/index.html"><button>üìç Bin Lookup</button></a>
    <div class="spacer"></div>
    <div class="small">Ops Tools</div>
  </div>
</div>

<h1>Picks</h1>

<div class="card">
  <div class="row">
    <label>Pick FROM:</label>
    <select id="fromLoc">
      <option value="warehouse" selected>Warehouse-66</option>
      <option value="container">Container - PLY</option>
      <option value="green">Green Harbor</option>
      <option value="plymouth">Plymouth</option>
    </select>

    <label>
      <input type="checkbox" id="fallback" checked>
      WH ‚Üí Container fallback
    </label>

    <label>Pick TO:</label>
    <select id="toLoc">
      <option value="plymouth">Plymouth</option>
      <option value="green">Green Harbor</option>
      <option value="both">Both</option>
    </select>

    <button class="primary" onclick="buildPick()">Build Pick</button>
    <button onclick="downloadCSV()" id="downloadBtn" disabled>Download CSV</button>
  </div>

  <div id="loadMsg" style="margin-top:12px;display:none" class="warn"></div>
</div>

<div class="card">
  <table>
    <thead>
      <tr id="tableHead"></tr>
    </thead>
    <tbody id="results"></tbody>
  </table>
</div>

<script>
/** DATA SOURCE **/
const CSV_URL = '../pickle-data.csv';

/** COLUMN NAMES (must match your Shopify export headers) **/
const COL_BARCODE = 'Variant Barcode';
const COL_TITLE = 'Title';
const COL_WH_BIN = 'Variant Metafield: custom.wh_bin [single_line_text_field]';

const COL_WH_AV = 'Inventory Available: Warehouse-66';
const COL_CONT_AV = 'Inventory Available: Container - PLY';
const COL_PLY_ON = 'Inventory Available: Plymouth';
const COL_GH_ON = 'Inventory Available: Green Harbor';

const COL_PLY_MIN = 'Variant Metafield: custom.minply [number_integer]';
const COL_PLY_MAX = 'Variant Metafield: custom.maxply [number_integer]';
const COL_GH_MIN = 'Variant Metafield: custom.mingh [number_integer]';
const COL_GH_MAX = 'Variant Metafield: custom.maxgh [number_integer]';

let rows = [];
let lastPick = [];

/** STRICT INTEGER PARSER:
 *  - blank => 0
 *  - non-numeric => 0
 *  - decimals => floored
 */
function n(v){
  const s = String(v ?? '').trim();
  if(!s) return 0;
  const num = Number(s);
  return Number.isFinite(num) ? Math.floor(num) : 0;
}

function need(on,min,max){
  if(!(on < min)) return 0;
  return Math.max(max - on, 0);
}

/** Renders table headers based on TO selection */
function renderTableHead(to){
  let h = `
    <th>Barcode</th>
    <th>Title</th>
    <th>WH Bin</th>
    <th>WH Available</th>
  `;

  if(to === 'plymouth'){
    h += `<th>PLY</th>`;
  } else if(to === 'green'){
    h += `<th>GH</th>`;
  } else {
    h += `<th>PLY</th><th>GH</th>`;
  }

  document.getElementById('tableHead').innerHTML = h;
}

/** CSV PARSER (handles quotes + commas correctly) */
function parseCSV(text){
  // Normalize line endings
  text = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n');

  const rows = [];
  let row = [];
  let field = '';
  let inQuotes = false;

  for(let i=0;i<text.length;i++){
    const c = text[i];

    if(inQuotes){
      if(c === '"'){
        // double quote inside quoted field => literal quote
        if(text[i+1] === '"'){
          field += '"';
          i++;
        } else {
          inQuotes = false;
        }
      } else {
        field += c;
      }
    } else {
      if(c === '"'){
        inQuotes = true;
      } else if(c === ','){
        row.push(field);
        field = '';
      } else if(c === '\n'){
        row.push(field);
        field = '';
        // Ignore totally empty trailing lines
        if(row.length > 1 || (row.length === 1 && row[0].trim() !== '')){
          rows.push(row);
        }
        row = [];
      } else {
        field += c;
      }
    }
  }

  // last field
  row.push(field);
  if(row.length > 1 || (row.length === 1 && row[0].trim() !== '')){
    rows.push(row);
  }

  if(!rows.length) return { headers: [], records: [] };

  const headers = rows[0].map(h => String(h ?? '').trim());
  const records = rows.slice(1).map(r => {
    const obj = {};
    headers.forEach((h, idx) => {
      obj[h] = (r[idx] ?? '').trim();
    });
    return obj;
  });

  return { headers, records };
}

/** Load CSV */
async function loadCSV(){
  const msg = document.getElementById('loadMsg');
  msg.style.display = 'none';
  msg.textContent = '';

  const res = await fetch(CSV_URL + '?v=' + Date.now(), { cache: 'no-store' });
  if(!res.ok) throw new Error('Failed to load pickle-data.csv (HTTP ' + res.status + ')');

  const text = await res.text();
  const parsed = parseCSV(text);

  rows = parsed.records;

  // Quick sanity: if we can't find key columns, warn loudly
  const required = [COL_BARCODE, COL_TITLE, COL_WH_AV, COL_CONT_AV, COL_PLY_ON, COL_GH_ON];
  const missing = required.filter(col => !(col in (rows[0] || {})));
  if(missing.length){
    msg.style.display = 'block';
    msg.textContent = 'Warning: pickle-data.csv is missing expected columns. Picks may be wrong. Missing: ' + missing.join(' | ');
  }
}

/** Build pick list */
function buildPick(){
  const from = document.getElementById('fromLoc').value;
  const to = document.getElementById('toLoc').value;
  const fallback = document.getElementById('fallback').checked;

  renderTableHead(to);

  const tbody = document.getElementById('results');
  tbody.innerHTML = '';
  lastPick = [];

  rows.forEach(r=>{
    // Skip totally blank SKU rows
    const barcode = String(r[COL_BARCODE] || '').trim();
    const title = String(r[COL_TITLE] || '').trim();
    if(!barcode && !title) return;

    const wh = n(r[COL_WH_AV]);
    const cont = n(r[COL_CONT_AV]);

    // WH Available: treated as integer; blanks become 0 automatically by n()
    let whAvailable = 0;

    if(from === 'warehouse' && fallback){
      if(wh > 0) whAvailable = wh;
      else if(cont > 0) whAvailable = cont;
      else return; // nothing to pick from
    } else {
      whAvailable =
        (from==='warehouse') ? wh :
        (from==='container') ? cont :
        (from==='green') ? n(r[COL_GH_ON]) :
        n(r[COL_PLY_ON]);

      if(whAvailable <= 0) return;
    }

    const plyNeed = need(n(r[COL_PLY_ON]), n(r[COL_PLY_MIN]), n(r[COL_PLY_MAX]));
    const ghNeed  = need(n(r[COL_GH_ON]),  n(r[COL_GH_MIN]),  n(r[COL_GH_MAX]));

    let plyPick = 0;
    let ghPick = 0;

    if(to === 'plymouth'){
      plyPick = Math.min(plyNeed, whAvailable);
    } else if(to === 'green'){
      ghPick = Math.min(ghNeed, whAvailable);
    } else {
      plyPick = Math.min(plyNeed, whAvailable);
      ghPick  = Math.min(ghNeed,  whAvailable - plyPick);
    }

    if(plyPick <= 0 && ghPick <= 0) return;

    const tr = document.createElement('tr');

    let rowHTML = `
      <td class="mono">${barcode}</td>
      <td>${title}</td>
      <td>${(r[COL_WH_BIN]||'')}</td>
      <td>${whAvailable}</td>
    `;

    if(to === 'plymouth'){
      rowHTML += `<td>${plyPick}</td>`;
    } else if(to === 'green'){
      rowHTML += `<td>${ghPick}</td>`;
    } else {
      rowHTML += `<td>${plyPick}</td><td>${ghPick}</td>`;
    }

    tr.innerHTML = rowHTML;
    tbody.appendChild(tr);

    lastPick.push({ r, whAvailable, plyPick, ghPick, to });
  });

  document.getElementById('downloadBtn').disabled = !lastPick.length;
}

/** Workflow filename */
function pad2(x){ return String(x).padStart(2,'0'); }

function makePickFilename(to){
  const d = new Date();
  const yyyy = d.getFullYear();
  const mm = pad2(d.getMonth()+1);
  const dd = pad2(d.getDate());
  const hh = pad2(d.getHours());
  const min = pad2(d.getMinutes());

  const dest =
    to === 'plymouth' ? 'PLY' :
    to === 'green' ? 'GH' :
    'BOTH';

  return `PICKS_${dest}_${yyyy}-${mm}-${dd}_${hh}${min}.csv`;
}

/** Download CSV */
function downloadCSV(){
  if(!lastPick.length) return;

  const to = lastPick[0].to;

  let header = 'Barcode,Title,WH Bin,WH Available';
  if(to === 'plymouth') header += ',PLY\n';
  else if(to === 'green') header += ',GH\n';
  else header += ',PLY,GH\n';

  let csv = header;

  lastPick.forEach(p=>{
    const barcode = String(p.r[COL_BARCODE] || '').trim();
    const title = String(p.r[COL_TITLE] || '').trim();
    const bin = String(p.r[COL_WH_BIN] || '').trim();

    // Quote title safely (titles can contain commas)
    const safeTitle = `"${title.replace(/"/g,'""')}"`;

    let line = `="${barcode}",${safeTitle},${bin},${p.whAvailable}`;

    if(p.to === 'plymouth') line += `,${p.plyPick}`;
    else if(p.to === 'green') line += `,${p.ghPick}`;
    else line += `,${p.plyPick},${p.ghPick}`;

    csv += line + '\n';
  });

  const blob = new Blob([csv], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = makePickFilename(to);
  a.click();
  URL.revokeObjectURL(url);
}

// init
loadCSV().catch(err=>{
  const msg = document.getElementById('loadMsg');
  msg.style.display = 'block';
  msg.textContent = (err && err.message) ? err.message : 'Failed to load pickle-data.csv';
});
</script>

</body>
</html>
