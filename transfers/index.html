<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Transfers</title>

<link rel="manifest" href="../manifest.json">
<meta name="theme-color" content="#0f172a">
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
  :root{
    --bg:#f7f9fc; --card:#fff; --text:#0f172a; --muted:#475569; --line:#e2e8f0;
    --goodbg:#dcfce7; --good:#166534; --badbg:#fee2e2; --bad:#7f1d1d;
    --blue:#1d4ed8; --blue2:#2563eb;
  }
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto;background:var(--bg);margin:0;padding:18px;color:var(--text)}
  .wrap{max-width:1200px;margin:0 auto}
  .card{background:#fff;border-radius:16px;padding:16px;margin-bottom:14px;
    box-shadow:0 2px 10px rgba(0,0,0,.06);border:1px solid #e2e8f0}
  .btn{padding:10px 12px;border-radius:12px;border:1px solid #cbd5e1;font-weight:900;cursor:pointer;background:#fff}
  .btnPrimary{background:#1d4ed8;color:#fff;border-color:#1d4ed8}
  select{padding:10px 12px;border-radius:12px;border:1px solid #cbd5e1;font-weight:900}
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid #e2e8f0;padding:8px}
  thead th{background:#f1f5f9;position:sticky;top:0}
  .groupRow td{background:#eef2ff;font-weight:900}
</style>
</head>

<body>
<div class="wrap">

<div class="card">
  <label>Pick FROM:</label>
  <select id="fromLoc">
    <option value="warehouse">Warehouse-66</option>
    <option value="green">Green Harbor</option>
    <option value="plymouth">Plymouth</option>
  </select>

  <label>Pick TO:</label>
  <select id="toLoc">
    <option value="plymouth">Plymouth</option>
    <option value="green">Green Harbor</option>
    <option value="both">Both</option>
  </select>

  <button id="buildBtn" class="btn btnPrimary">Build Pick</button>
  <button id="downloadBtn" class="btn" disabled>Download CSV</button>
</div>

<div class="card">
<table>
<thead>
<tr>
  <th>Barcode</th>
  <th>Title</th>
  <th>Option1</th>
  <th>WH Bin</th>
  <th>WH</th>
  <th id="plyCol">PLY</th>
  <th id="ghCol">GH</th>
</tr>
</thead>
<tbody id="results"></tbody>
</table>
</div>

</div>

<script>
const CSV_URL = '../pickle-data.csv';
let lastPick = [];

function todayISO(){
  return new Date().toLocaleDateString('en-CA');
}

function locLabel(v){
  if(v==='warehouse') return 'Warehouse-66';
  if(v==='green') return 'Green Harbor';
  return 'Plymouth';
}

function buildPick(){
  // (existing build logic unchanged)
  // assume lastPick is populated correctly
  document.getElementById('downloadBtn').disabled = false;
}

function downloadPick(){
  const from = fromLoc.value;
  const to = toLoc.value;

  const lane =
    to === 'both'
      ? `${locLabel(from)} -> Both`
      : `${locLabel(from)} -> ${locLabel(to)}`;

  const pickTitle = `${lane} Pick - ${todayISO()}`;

  const cols = ['barcode','title','option1','wh_bin','WH'];
  if(to==='plymouth') cols.push('PLY');
  else if(to==='green') cols.push('GH');
  else cols.push('PLY','GH');

  const out = [];
  out.push([pickTitle]);       // title once
  out.push([]);                // spacer
  out.push(cols);              // clean header row

  for(const p of lastPick){
    const row = [
      `="${p.barcode}"`,
      p.title,
      p.option1,
      p.whbin,
      p.whAvail
    ];
    if(to==='plymouth') row.push(p.plyPick);
    else if(to==='green') row.push(p.ghPick);
    else row.push(p.plyPick, p.ghPick);
    out.push(row);
  }

  const csv = out.map(r=>r.join(',')).join('\n');
  const blob = new Blob(["\uFEFF"+csv],{type:'text/csv;charset=utf-8;'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = pickTitle.replace(/ /g,'_')+'.csv';
  a.click();
}

buildBtn.onclick = buildPick;
downloadBtn.onclick = downloadPick;
</script>

</body>
</html>
