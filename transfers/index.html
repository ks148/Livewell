<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Picks</title>

<link rel="manifest" href="../manifest.json">
<meta name="theme-color" content="#0f172a">
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
:root{
--bg:#f7f9fc; --card:#fff; --text:#0f172a; --muted:#475569; --line:#e2e8f0;
--goodbg:#dcfce7; --good:#166534; --badbg:#fee2e2; --bad:#7f1d1d;
--blue:#1d4ed8; --blue2:#2563eb;
}
body{font-family:system-ui,-apple-system,Segoe UI,Roboto;background:var(--bg);margin:0;padding:18px;color:var(--text)}
.wrap{max-width:1200px;margin:0 auto}
.card{background:var(--card);border-radius:16px;padding:16px;margin-bottom:14px;
box-shadow:0 2px 10px rgba(0,0,0,.06);border:1px solid rgba(226,232,240,.7)}
.row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
.btn{padding:10px 12px;border-radius:12px;border:1px solid var(--line);font-weight:900;cursor:pointer;background:#fff}
.btnPrimary{background:var(--blue);border-color:var(--blue);color:#fff}
select{padding:10px 12px;font-size:14px;border-radius:12px;border:1px solid #cbd5e1;background:#fff;font-weight:900}
.chk{display:flex;align-items:center;gap:8px}
table{width:100%;border-collapse:collapse;font-size:14px}
th,td{border-bottom:1px solid var(--line);padding:10px;text-align:left}
thead th{background:#f1f5f9}
.mono{font-family:ui-monospace,monospace}
.hide{display:none}
.badge{display:inline-block;padding:2px 10px;border-radius:999px;font-size:12px;font-weight:900}
.good{background:var(--goodbg);color:var(--good)}
.bad{background:var(--badbg);color:var(--bad)}
</style>
</head>

<body>
<div class="wrap">

<h1>Picks</h1>

<div class="card">
<div class="row">
<label>Pick FROM:</label>
<select id="fromLoc">
<option value="warehouse" selected>Warehouse-66</option>
<option value="container">Container - PLY</option>
<option value="green">Green Harbor</option>
<option value="plymouth">Plymouth</option>
</select>

<div class="chk">
<input id="fallbackWHToContainer" type="checkbox" checked>
<label>WH â†’ Container fallback</label>
</div>

<label>Pick TO:</label>
<select id="toLoc">
<option value="plymouth">Plymouth</option>
<option value="green">Green Harbor</option>
<option value="warehouse">Warehouse-66</option>
<option value="both">Both (PLY + GH)</option>
</select>

<button id="buildBtn" class="btn btnPrimary">Build Pick</button>
<button id="downloadBtn" class="btn" disabled>Download CSV</button>
</div>
</div>

<div class="card">
<table>
<thead>
<tr>
<th>Barcode</th>
<th>Title</th>
<th>WH Bin</th>
<th>FROM (actual)</th>
<th>Source Avail</th>
<th id="thPLY">PLY</th>
<th id="thGH">GH</th>
</tr>
</thead>
<tbody id="results"></tbody>
</table>
</div>

</div>

<script>

const CSV_URL = '../pickle-data.csv';

const COL_BARCODE = 'Variant Barcode';
const COL_TITLE = 'Title';
const COL_WH_BIN = 'Variant Metafield: custom.wh_bin [single_line_text_field]';

const COL_PLY_ON = 'Inventory Available: Plymouth';
const COL_GH_ON  = 'Inventory Available: Green Harbor';
const COL_WH_AV  = 'Inventory Available: Warehouse-66';
const COL_CONT_AV = 'Inventory Available: Container - PLY';

const COL_PLY_MIN = 'Variant Metafield: custom.minply [number_integer]';
const COL_PLY_MAX = 'Variant Metafield: custom.maxply [number_integer]';
const COL_GH_MIN  = 'Variant Metafield: custom.mingh [number_integer]';
const COL_GH_MAX  = 'Variant Metafield: custom.maxgh [number_integer]';

let rows = [];
let lastPick = [];

function n(v){
return Number(String(v||'').replace(/[^0-9.-]/g,'')) || 0;
}

function need(on,min,max){
if(!(on < min)) return 0;
return Math.max(max - on,0);
}

async function loadCSV(){
const res = await fetch(CSV_URL+'?v='+Date.now());
const text = await res.text();
const lines = text.split(/\r?\n/).filter(l=>l.trim());
const headers = lines[0].split(',');
rows = lines.slice(1).map(l=>{
const parts=l.split(',');
let obj={};
headers.forEach((h,i)=>obj[h.trim()]=parts[i]?.trim());
return obj;
});
}

function buildPick(){
const from=document.getElementById('fromLoc').value;
const to=document.getElementById('toLoc').value;
const fallback=document.getElementById('fallbackWHToContainer').checked;

const results=document.getElementById('results');
results.innerHTML='';
lastPick=[];

rows.forEach(r=>{
const wh=n(r[COL_WH_AV]);
const cont=n(r[COL_CONT_AV]);

let sourceAvail=0;
let actualFrom=from;

if(from==='warehouse' && fallback){
if(wh>0){ sourceAvail=wh; actualFrom='warehouse'; }
else if(cont>0){ sourceAvail=cont; actualFrom='container'; }
}else{
sourceAvail=(from==='warehouse')?wh:
(from==='container')?cont:
(from==='green')?n(r[COL_GH_ON]):
n(r[COL_PLY_ON]);
}

if(sourceAvail<=0) return;

const plyNeed=need(n(r[COL_PLY_ON]),n(r[COL_PLY_MIN]),n(r[COL_PLY_MAX]));
const ghNeed=need(n(r[COL_GH_ON]),n(r[COL_GH_MIN]),n(r[COL_GH_MAX]));

let plyPick=0,ghPick=0;

if(to==='plymouth') plyPick=Math.min(plyNeed,sourceAvail);
else if(to==='green') ghPick=Math.min(ghNeed,sourceAvail);
else if(to==='both'){
plyPick=Math.min(plyNeed,sourceAvail);
ghPick=Math.min(ghNeed,sourceAvail-plyPick);
}

if(plyPick<=0 && ghPick<=0) return;

const tr=document.createElement('tr');
tr.innerHTML=`
<td class="mono">${r[COL_BARCODE]||''}</td>
<td>${r[COL_TITLE]||''}</td>
<td>${r[COL_WH_BIN]||''}</td>
<td><strong>${actualFrom==='warehouse'?'Warehouse-66':'Container - PLY'}</strong></td>
<td>${sourceAvail}</td>
<td>${plyPick}</td>
<td>${ghPick}</td>
`;
results.appendChild(tr);

lastPick.push({r,plyPick,ghPick,actualFrom,sourceAvail});
});

document.getElementById('downloadBtn').disabled=!lastPick.length;
}

function downloadPick(){
let csv='Barcode,Title,WH Bin,From,SourceAvail,PLY,GH\n';
lastPick.forEach(p=>{
csv+=`="${p.r[COL_BARCODE]||''}",${p.r[COL_TITLE]||''},${p.r[COL_WH_BIN]||''},${p.actualFrom},${p.sourceAvail},${p.plyPick},${p.ghPick}\n`;
});
const blob=new Blob([csv],{type:'text/csv'});
const url=URL.createObjectURL(blob);
const a=document.createElement('a');
a.href=url;
a.download='pick.csv';
a.click();
URL.revokeObjectURL(url);
}

document.getElementById('buildBtn').onclick=buildPick;
document.getElementById('downloadBtn').onclick=downloadPick;

loadCSV();

</script>
</body>
</html>
