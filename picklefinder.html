<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>PickleFinder</title>

<meta name="theme-color" content="#0f172a">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="PickleFinder">

<style>
  body{
    margin:0;
    background:#f7f9fc;
    color:#111827;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
  }
  .wrap{max-width:960px;margin:20px auto;padding:0 14px;}
  h1{margin:0 0 10px;font-size:26px;}
  .card{
    background:#fff;
    border:1px solid #d8dee9;
    border-radius:12px;
    padding:16px;
    margin:12px 0;
  }
  .btn{
    width:100%;
    padding:12px;
    border-radius:10px;
    border:none;
    font-size:16px;
    font-weight:800;
    cursor:pointer;
    background:#2563eb;
    color:#fff;
  }
  .btn.secondary{background:#e5e7eb;color:#111;}
  .status{
    margin-top:10px;
    padding:12px;
    border-radius:10px;
    background:#dcfce7;
    border:1px solid #86efac;
    color:#14532d;
    font-weight:800;
    display:none;
  }
  .scan{
    width:100%;
    padding:14px;
    font-size:22px;
    border-radius:12px;
    border:1px solid #d8dee9;
  }
  .bin{
    font-size:64px;
    font-weight:900;
    letter-spacing:2px;
    margin-top:10px;
  }
  .notfound{color:#b91c1c;font-weight:900;font-size:20px;}
  table{width:100%;border-collapse:collapse;margin-top:10px;}
  th,td{padding:8px;border-bottom:1px solid #e5e7eb;font-size:14px;}
  tbody tr:nth-child(even){background:#f9fafb;}
  #csvFile{display:none;}
</style>
</head>
<body>

<div class="wrap">
  <h1>PickleFinder</h1>

  <div class="card">
    <button class="btn secondary" id="changeCsv">Change CSV (Safari only)</button>
    <input type="file" id="csvFile" accept=".csv">
    <div class="status" id="status"></div>
  </div>

  <div class="card">
    <input id="scan" class="scan" placeholder="Scan barcode or SKU" autofocus>
    <div id="result"></div>
  </div>

  <div class="card">
    <strong>Scan Log</strong>
    <table>
      <thead>
        <tr><th>Time</th><th>Bin</th><th>Barcode</th><th>Title</th></tr>
      </thead>
      <tbody id="log"></tbody>
    </table>
  </div>
</div>

<script>
let rows = [];
const COL_BARCODE = "Variant Barcode";
const COL_SKU = "Variant SKU";
const COL_BIN = "Variant Metafield: custom.wh_bin [single_line_text_field]";
const COL_TITLE = "Title";

const status = document.getElementById("status");
const scan = document.getElementById("scan");
const log = document.getElementById("log");
const result = document.getElementById("result");
const csvFile = document.getElementById("csvFile");

function parseCSV(text){
  const lines = text.split(/\r?\n/).filter(l=>l.trim());
  const headers = lines.shift().split(",");
  return lines.map(l=>{
    const vals = l.split(",");
    const o={};
    headers.forEach((h,i)=>o[h]=vals[i]||"");
    return o;
  });
}

async function loadServerCSV(){
  try{
    const res = await fetch("bin%20locations.csv",{cache:"no-store"});
    if(!res.ok) throw new Error("no csv");
    const text = await res.text();
    rows = parseCSV(text);
    status.style.display="block";
    status.textContent =
      `Loaded bin locations.csv • ${rows.length} rows • ${new Date().toLocaleString()}`;
  }catch(e){
    status.style.display="block";
    status.textContent = "Could not auto-load CSV. Use Safari to load manually.";
  }
}

csvFile.addEventListener("change",async e=>{
  const f=e.target.files[0];
  if(!f) return;
  const text=await f.text();
  rows=parseCSV(text);
  status.style.display="block";
  status.textContent =
    `Loaded ${f.name} • ${rows.length} rows • ${new Date().toLocaleString()}`;
  scan.focus();
});

document.getElementById("changeCsv").onclick=()=>{
  csvFile.click();
};

scan.addEventListener("keydown",e=>{
  if(e.key==="Enter"){
    const q=scan.value.trim();
    scan.value="";
    const m=rows.find(r=>r[COL_BARCODE]===q||r[COL_SKU]===q);
    if(!m){
      result.innerHTML='<div class="notfound">Not found</div>';
      return;
    }
    result.innerHTML=`
      <div class="bin">${m[COL_BIN]||"—"}</div>
      <div><strong>Barcode:</strong> ${m[COL_BARCODE]||""}</div>
      <div><strong>Title:</strong> ${m[COL_TITLE]||""}</div>
    `;
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${new Date().toLocaleTimeString()}</td>
      <td>${m[COL_BIN]||""}</td>
      <td>${m[COL_BARCODE]||""}</td>
      <td>${m[COL_TITLE]||""}</td>`;
    log.prepend(tr);
  }
});

loadServerCSV();
</script>
</body>
</html>
