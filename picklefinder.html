<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Warehouse Bin Lookup</title>
<style>
    body {
        font-family: Arial, sans-serif;
        background: #f5f5f5;
        padding: 20px;
        padding-top: 72px;
    }
    h1 {
        margin-bottom: 10px;
    }
    .card {
        background: white;
        padding: 20px;
        border-radius: 8px;
        max-width: 900px;
        margin-bottom: 20px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    .scan-input {
        font-size: 22px;
        padding: 10px;
        width: 100%;
        margin-top: 10px;
    }
    .bin-display {
        font-size: 56px;
        font-weight: bold;
        color: #111;
        margin: 15px 0;
        letter-spacing: 2px;
    }
    .detail {
        font-size: 18px;
        margin: 4px 0;
    }
    .not-found {
        color: red;
        font-weight: bold;
        font-size: 20px;
    }
    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
    }
    th, td {
        padding: 8px;
        border-bottom: 1px solid #ddd;
        text-align: left;
    }
    th {
        background: #eee;
    }
    button {
        padding: 8px 14px;
        font-size: 14px;
        cursor: pointer;
    }
    .hidden {
        display: none;
    }

    .status-bar{
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 9999;
        padding: 12px 16px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.08);
        border-bottom: 1px solid rgba(0,0,0,0.08);
        font-size: 14px;
    }

    .status-bar.not-loaded{
        background: #fee2e2;
        color: #7f1d1d;
    }

    .status-bar.loaded{
        background: #dcfce7;
        color: #14532d;
    }

    .status-actions{
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
        justify-content: flex-end;
    }

    .link-btn{
        background: transparent;
        border: 1px solid rgba(0,0,0,0.18);
        padding: 6px 10px;
        border-radius: 8px;
        font-size: 13px;
        cursor: pointer;
    }

    .link-btn:active{ transform: translateY(1px); }

    .status-strong{ font-weight: 700; }
</style>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0f172a">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="PickleFinder">
</head>
<body>

<div id="statusBar" class="status-bar not-loaded">
  <div>
    <span class="status-strong">PickleFinder:</span>
    <span id="statusText">No CSV loaded.</span>
  </div>
  <div class="status-actions">
    <button id="changeCsvBtn" type="button" class="link-btn">Load / Change CSV</button>
  </div>
</div>

<!-- Hidden file input (used by the status bar button) -->
<input type="file" id="csvFile" accept=".csv" class="hidden">

<h1>Warehouse Bin Lookup</h1>

<div class="card" id="csvLoader">
    <label><strong>1) Load CSV File</strong></label><br>
    <div class="small" style="margin-top:6px;">
      Tip: after you load the CSV once, this box hides and PickleFinder will stay focused on scanning.
    </div>
    <button id="loadCsvBtn" type="button" style="margin-top:10px;">Choose CSV…</button>
</div>

<div class="card">
    <label><strong>2) Scan Barcode / SKU</strong></label>
    <input type="text" id="scanInput" class="scan-input" placeholder="Scan barcode and press Enter" autofocus>

    <div id="result"></div>
</div>

<div class="card">
    <strong>Scan Log</strong>
    <button onclick="clearLog()" style="float:right;">Clear Log</button>
    <table>
        <thead>
            <tr>
                <th>Time</th>
                <th>WH Bin</th>
                <th>Barcode</th>
                <th>Title</th>
            </tr>
        </thead>
        <tbody id="logTable"></tbody>
    </table>
</div>

<script>
let rows = [];
let headers = [];
let loadedMeta = { loadedAt: null, fileName: null, rowCount: 0 };

const statusBar = document.getElementById('statusBar');
const statusText = document.getElementById('statusText');
const changeCsvBtn = document.getElementById('changeCsvBtn');
const loadCsvBtn = document.getElementById('loadCsvBtn');
const csvLoader = document.getElementById('csvLoader');
const csvFileInput = document.getElementById('csvFile');
const scanInput = document.getElementById('scanInput');
const resultDiv = document.getElementById('result');

function focusScan(){
  // small delay helps on iPad Safari after dialogs / file picker
  setTimeout(()=>{ try{ scanInput.focus(); }catch(e){} }, 50);
}

function formatLoadedAt(date){
  try{
    return date.toLocaleString(undefined, { year:'numeric', month:'short', day:'2-digit', hour:'2-digit', minute:'2-digit' });
  }catch(e){
    return date.toLocaleString();
  }
}

function setStatus(loaded){
  if(!loaded){
    statusBar.classList.remove('loaded');
    statusBar.classList.add('not-loaded');
    statusText.textContent = 'No CSV loaded.';
    return;
  }
  statusBar.classList.remove('not-loaded');
  statusBar.classList.add('loaded');
  const when = loadedMeta.loadedAt ? formatLoadedAt(loadedMeta.loadedAt) : '';
  const name = loadedMeta.fileName ? `“${loadedMeta.fileName}”` : 'CSV';
  statusText.textContent = `${name} loaded — ${loadedMeta.rowCount.toLocaleString()} items — Updated ${when}`;
}

// Robust CSV parser (handles quotes/commas)
function parseCSV(text){
  const out=[]; let i=0, field='', row=[], inQuotes=false;
  while(i<text.length){
    const c=text[i];
    if(c==='"'){
      if(inQuotes && text[i+1]==='"'){ field+='"'; i++; }
      else inQuotes=!inQuotes;
    } else if(c===',' && !inQuotes){
      row.push(field); field='';
    } else if((c==='\n' || c==='\r') && !inQuotes){
      if(field!=='' || row.length){ row.push(field); out.push(row); row=[]; field=''; }
      if(c==='\r' && text[i+1]==='\n') i++;
    } else {
      field+=c;
    }
    i++;
  }
  if(field!=='' || row.length){ row.push(field); out.push(row); }
  if(out.length && out[0].length){ out[0][0] = out[0][0].replace(/^\uFEFF/,''); }
  return out;
}

function normalizeHeader(h){
  return String(h ?? '').replace(/(^"|"$)/g,'').trim();
}

function normalizeCell(v){
  return String(v ?? '').replace(/(^"|"$)/g,'').trim();
}

function loadCsvFromFile(file){
  if(!file) return;
  const reader = new FileReader();
  reader.onload = function(evt){
    const table = parseCSV(evt.target.result);
    if(!table.length){
      alert('CSV appears empty.');
      return;
    }

    headers = (table[0] || []).map(normalizeHeader);

    rows = table.slice(1)
      .filter(r => r && r.some(cell => normalizeCell(cell) !== ''))
      .map(r => {
        const obj = {};
        headers.forEach((h, i) => obj[h] = normalizeCell(r[i]));
        return obj;
      });

    loadedMeta.loadedAt = new Date();
    loadedMeta.fileName = file.name || null;
    loadedMeta.rowCount = rows.length;

    // Hide loader UI after successful load to prevent accidental changes
    csvLoader.classList.add('hidden');
    setStatus(true);
    focusScan();
  };
  reader.readAsText(file);
}

// Buttons to open the file picker
changeCsvBtn.addEventListener('click', ()=>{
  if(loadedMeta.loadedAt){
    const ok = confirm('Load a different CSV? (This replaces the current file in PickleFinder.)');
    if(!ok) { focusScan(); return; }
  }
  csvFileInput.value = '';
  csvFileInput.click();
});

loadCsvBtn.addEventListener('click', ()=>{
  csvFileInput.value = '';
  csvFileInput.click();
});

csvFileInput.addEventListener('change', function(e){
  const file = e.target.files && e.target.files[0];
  if(!file) { focusScan(); return; }
  loadCsvFromFile(file);
});

scanInput.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        const q = this.value.trim();
        this.value = "";
        lookupItem(q);
        focusScan();
    }
});

function lookupItem(code) {
    if (!code) return;
    if (rows.length === 0) {
        resultDiv.innerHTML = '<div class="not-found">Load a CSV first</div>';
        setStatus(false);
        return;
    }

    const match = rows.find(r =>
        r["Variant Barcode"] === code ||
        r["Variant SKU"] === code
    );

    if (!match) {
        resultDiv.innerHTML = '<div class="not-found">Item not found</div>';
        return;
    }

    const bin = match["Variant Metafield: custom.wh_bin [single_line_text_field]"] || "—";
    const barcode = match["Variant Barcode"] || "—";
    const title = match["Title"] || "—";

    resultDiv.innerHTML = \`
        <div class="bin-display">\${bin}</div>
        <div class="detail"><strong>Barcode:</strong> \${barcode}</div>
        <div class="detail"><strong>Title:</strong> \${title}</div>
    \`;

    addLog(bin, barcode, title);
}

function addLog(bin, barcode, title) {
    const table = document.getElementById('logTable');
    const row = table.insertRow(0);
    row.insertCell(0).innerText = new Date().toLocaleTimeString();
    row.insertCell(1).innerText = bin;
    row.insertCell(2).innerText = barcode;
    row.insertCell(3).innerText = title;
}

function clearLog() {
    document.getElementById('logTable').innerHTML = "";
    focusScan();
}

// Keep scanner focus (helps on iPad)
document.addEventListener('click', (e)=>{
  // Don't steal focus during file picking
  if(e.target && (e.target.id === 'changeCsvBtn' || e.target.id === 'loadCsvBtn')) return;
  focusScan();
});

window.addEventListener('load', ()=>{
  setStatus(false);
  focusScan();
});
</script>


<script>
  // PWA offline cache (basic)
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('sw.js').catch(()=>{});
    });
  }
</script>

</body>
</html>
