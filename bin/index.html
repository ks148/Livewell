<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Livewell ‚Äì Bin</title>

<link rel="manifest" href="../manifest.json">
<meta name="theme-color" content="#0f172a">

<style>
  :root{
    --bg:#f7f9fc; --card:#fff; --text:#0f172a; --muted:#475569; --line:#e2e8f0;
    --goodbg:#dcfce7; --good:#166534; --badbg:#fee2e2; --bad:#7f1d1d;
    --warnbg:#fff7ed; --warn:#9a3412;
    --blue:#1d4ed8; --blue2:#2563eb;
  }
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto;background:var(--bg);margin:0;padding:18px;color:var(--text)}
  .wrap{max-width:1100px;margin:0 auto}

  /* NAV */
  .topnav{
    position:sticky; top:0; z-index:50;
    background:#fff;
    border:1px solid var(--line);
    border-radius:14px;
    padding:10px;
    margin-bottom:14px;
    box-shadow:0 2px 10px rgba(0,0,0,.05);
  }
  .topnav .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .topnav a{text-decoration:none}
  .topnav button{
    padding:8px 14px;border-radius:10px;border:1px solid #d1d5db;
    font-weight:900;cursor:pointer;background:#fff;
  }
  .topnav button.active{background:#0f172a;color:#fff;border-color:#0f172a}
  .topnav .spacer{flex:1}
  .small{font-size:12px;color:var(--muted);font-weight:900}

  h1{margin:6px 0 6px;font-size:34px}
  h2{margin:0;font-size:20px}
  .sub{margin:6px 0 0;color:var(--muted);font-size:13px;line-height:1.35}
  .sectionTitle{
    display:flex;align-items:center;justify-content:space-between;gap:12px;
    padding:10px 12px;border-radius:14px;border:1px dashed #cbd5e1;background:#f8fafc;
    margin-bottom:10px;
  }
  .sectionTitle .left{display:flex;flex-direction:column;gap:2px}
  .sectionTitle .right{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .tag{
    display:inline-block;padding:3px 10px;border-radius:999px;font-size:12px;font-weight:900;
    border:1px solid var(--line);background:#fff;color:#0f172a;
  }
  .tag.good{background:var(--goodbg);color:var(--good);border-color:#86efac}
  .tag.warn{background:var(--warnbg);color:var(--warn);border-color:#fed7aa}
  .tag.bad{background:var(--badbg);color:var(--bad);border-color:#fecaca}

  .card{background:var(--card);border-radius:16px;padding:16px;margin-bottom:14px;
    box-shadow:0 2px 10px rgba(0,0,0,.06);border:1px solid rgba(226,232,240,.7)}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}

  .btn{padding:10px 12px;border-radius:12px;border:1px solid var(--line);font-weight:900;cursor:pointer;background:#fff}
  .btn:active{transform:translateY(1px)}
  .btnPrimary{background:var(--blue);border-color:var(--blue);color:#fff}
  .btnPrimary:hover{background:var(--blue2)}
  .btnDanger{background:#7f1d1d;border-color:#7f1d1d;color:#fff}
  .btn:disabled{opacity:.45;cursor:not-allowed}

  input.big{font-size:24px;padding:12px 14px;width:100%;border-radius:14px;border:1px solid #cbd5e1;box-sizing:border-box}
  input.med{font-size:18px;padding:10px 12px;border-radius:12px;border:1px solid #cbd5e1;width:320px;max-width:100%;box-sizing:border-box}

  table{width:100%;border-collapse:collapse;font-size:14px}
  th,td{padding:10px;border-bottom:1px solid var(--line);text-align:left;vertical-align:top}
  tbody tr:nth-child(even){background:#f9fafb}
  .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}

  .cellInput{
    width:100%;
    box-sizing:border-box;
    padding:8px 10px;
    border-radius:10px;
    border:1px solid #cbd5e1;
    font-weight:900;
    font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    background:#fff;
  }

  .binBig{font-size:56px;font-weight:1000;margin:6px 0 0;letter-spacing:1px}
  code{background:#f3f4f6;padding:2px 6px;border-radius:8px}

  .kv{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
  .kv .pill{border:1px solid var(--line);background:#fff;border-radius:999px;padding:4px 10px;font-size:12px;font-weight:900;color:#0f172a}
  .muted{color:var(--muted)}
</style>
</head>

<body>
<div class="wrap">

  <!-- NAV -->
  <div class="topnav">
    <div class="row">
      <a href="../index.html"><button>üè† Home</button></a>
      <a href="../Picks/index.html"><button>üìã Picks</button></a>
      <a href="../putaway/index.html"><button>üì¶ Putaway</button></a>
      <a href="../bin/index.html"><button class="active">üìç Bin</button></a>
      <div class="spacer"></div>
      <div class="small">Ops Tools</div>
    </div>
  </div>

  <h1>Bin</h1>
  <p class="sub">
    This page has <strong>two separate tools</strong>:
    <strong>Bin Assignment</strong> (build CSV exports) and <strong>Smart Bin Lookup</strong> (scan bin or product).
    Data source: <code>pickle-data.csv</code>.
  </p>

  <!-- =======================
       SECTION 1: BIN ASSIGNMENT
       ======================= -->
  <div class="card">
    <div class="sectionTitle">
      <div class="left">
        <h2>1) BIN ASSIGNMENT (Scan ‚Üí CSV)</h2>
        <div class="sub">
          ‚úÖ Adds rows to the assignment table (in scan order). Exports CSVs.
          <strong>Does NOT</strong> change Shopify until you upload a CSV.
        </div>
      </div>
      <div class="right">
        <span id="assignStatus" class="tag warn">Loading‚Ä¶</span>
        <span id="assignHint" class="sub"></span>
      </div>
    </div>

    <div class="sub" style="margin-top:0">
      <strong>Fast scan flow:</strong>
      Scan item ‚Üí Enter ‚Üí cursor moves to Bin if empty ‚Üí scan bin ‚Üí Enter ‚Üí added ‚Üí cursor returns to Item.
      (Bin can be blank if you plan to generate sequential bins in Excel.)
    </div>

    <div class="row" style="margin-top:12px;align-items:flex-end">
      <div style="flex:1;min-width:260px">
        <div class="small">Scan item (barcode or SKU)</div>
        <input id="assignScan" class="big" placeholder="Scan item + Enter" autofocus />
      </div>

      <div style="min-width:280px">
        <div class="small">Bin value (optional)</div>
        <input id="assignBin" class="med mono" placeholder="Scan/type bin (optional) + Enter" />
      </div>

      <button class="btn btnPrimary" type="button" onclick="addAssignmentFromButtons()">Add</button>

      <button class="btn" type="button" onclick="downloadShopifyBinsCSV()" id="dlShopifyBtn" disabled>
        Shopify Bin Upload (CSV)
      </button>

      <button class="btn" type="button" onclick="downloadLabelPrintCSV()" id="dlLabelsBtn" disabled>
        Label Print CSV (BIN + ITEM)
      </button>

      <button class="btn" type="button" onclick="downloadAssignmentsRawCSV()" id="dlRawBtn" disabled>
        Assignment CSV (raw)
      </button>

      <button class="btn btnDanger" type="button" onclick="clearAssignments()">Clear</button>
    </div>

    <div id="assignPreview" class="sub" style="margin-top:10px"></div>

    <div style="overflow:auto; max-height:45vh; margin-top:8px">
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Variant ID</th>
            <th>Item Barcode</th>
            <th>SKU</th>
            <th>Title</th>
            <th>WH Bin (editable)</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="assignTable"></tbody>
      </table>
    </div>

    <div class="sub" style="margin-top:10px">
      <strong>Label Print CSV format:</strong> one row per printed label in the exact order:
      BIN label (bin text + bin barcode) then ITEM label (title + item barcode).
      Barcode values intended for Code 128.
    </div>
  </div>

  <!-- =======================
       SECTION 2: SMART BIN LOOKUP
       ======================= -->
  <div class="card">
    <div class="sectionTitle">
      <div class="left">
        <h2>2) SMART BIN LOOKUP (Scan BIN or PRODUCT)</h2>
        <div class="sub">
          ‚úÖ Scan a <strong>BIN</strong> to see what should be in it. Scan a <strong>PRODUCT</strong> to see what bin it should be in.
          <strong>Does NOT</strong> add to assignment exports.
        </div>
      </div>
      <div class="right">
        <span id="lookupStatus" class="tag warn">Loading‚Ä¶</span>
        <span id="modeBadge" class="tag warn">MODE: ‚Äî</span>
      </div>
    </div>

    <div id="meta" class="sub"></div>

    <div class="row" style="margin-top:10px">
      <button class="btn" type="button" onclick="loadCSV()">Reload from site</button>
      <button class="btn" type="button" onclick="openCSV()">Open CSV</button>
      <button class="btn" type="button" onclick="undoLastScan()">Undo Last Scan</button>
      <button class="btn" type="button" onclick="clearLog()">Clear Log</button>
      <div class="sub">Scans this session: <strong id="scanCount">0</strong></div>
    </div>

    <div style="margin-top:12px">
      <div class="small">Scan BIN label (bin code) OR scan product (barcode/SKU) then Enter</div>
      <input id="scan" class="big" placeholder="Scan BIN or product barcode/SKU and press Enter" />
      <div id="result" style="margin-top:12px"></div>
    </div>

    <div style="margin-top:14px; overflow:auto; max-height:50vh">
      <table>
        <thead><tr><th>Time</th><th>Type</th><th>Bin</th><th>Barcode</th><th>Title</th><th>Actions</th></tr></thead>
        <tbody id="log"></tbody>
      </table>
    </div>
  </div>

</div>

<script>
  const CSV_URL = '../pickle-data.csv';

  // pickle-data headers
  const COL_BARCODE = 'Variant Barcode'; // item barcode for ITEM label
  const COL_SKU = 'Variant SKU';
  const COL_TITLE = 'Title';
  const COL_BIN = 'Variant Metafield: custom.wh_bin [single_line_text_field]';

  // Optional: Warehouse on-hand column (will auto-detect if exact match exists)
  const COL_WH_ONHAND = 'Inventory Available: Warehouse-66';

  // Variant ID candidates
  const VARIANT_ID_CANDIDATES = [
    'Variant ID','Variant Id','variant_id','variant id','VariantID',
    'Variant: ID','Variant: Id'
  ];

  const DUP_WINDOW_MS = 2000;

  let rows = [];
  let logEntries = [];
  let lastScan = { key:'', ts:0 };

  // assignments in scan order
  let assignments = []; // {variantId, itemBarcode, sku, title, bin}

  // Elements
  const metaEl = document.getElementById('meta');
  const resultEl = document.getElementById('result');
  const logEl = document.getElementById('log');
  const scanCountEl = document.getElementById('scanCount');

  const lookupStatusEl = document.getElementById('lookupStatus');
  const modeBadgeEl = document.getElementById('modeBadge');

  const assignStatusEl = document.getElementById('assignStatus');
  const assignHintEl = document.getElementById('assignHint');
  const assignScanEl = document.getElementById('assignScan');
  const assignBinEl = document.getElementById('assignBin');
  const assignTableEl = document.getElementById('assignTable');
  const assignPreviewEl = document.getElementById('assignPreview');

  const dlShopifyBtn = document.getElementById('dlShopifyBtn');
  const dlLabelsBtn = document.getElementById('dlLabelsBtn');
  const dlRawBtn = document.getElementById('dlRawBtn');

  function esc(s){
    return String(s ?? '')
      .replace(/&/g,'&amp;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;');
  }

  function setTag(el, kind, text){
    el.className = 'tag ' + (kind || 'warn');
    el.textContent = text;
  }

  function nInt(v){
    const s = String(v ?? '').trim();
    if(!s) return 0;
    const num = Number(s);
    return Number.isFinite(num) ? Math.floor(num) : 0;
  }

  // CSV parsing
  function detectDelimiter(text) {
    const firstLine = (text.split(/\r?\n/).find(l => l.trim() !== '') || '');
    const candidates = [',',';','\t','|'];
    let best = ',', bestCount = -1;
    for (const d of candidates) {
      const c = firstLine.split(d).length;
      if (c > bestCount) { bestCount = c; best = d; }
    }
    return best;
  }
  function parseCSV(text, delimiter) {
    const out = [];
    let i = 0, field = '', row = [], inQuotes = false;
    if (text.charCodeAt(0) === 0xFEFF) text = text.slice(1);

    while (i < text.length) {
      const c = text[i];
      if (c === '"') {
        if (inQuotes && text[i+1] === '"') { field += '"'; i++; }
        else { inQuotes = !inQuotes; }
      } else if (c === delimiter && !inQuotes) {
        row.push(field); field = '';
      } else if ((c === '\n' || c === '\r') && !inQuotes) {
        if (field !== '' || row.length) { row.push(field); out.push(row); row = []; field = ''; }
        if (c === '\r' && text[i+1] === '\n') i++;
      } else {
        field += c;
      }
      i++;
    }
    if (field !== '' || row.length) { row.push(field); out.push(row); }
    return out;
  }
  function toObjects(matrix) {
    if (!matrix.length) return [];
    const headers = (matrix[0] || []).map(h => String(h ?? '').trim());
    const objects = [];
    for (let r = 1; r < matrix.length; r++) {
      const line = matrix[r];
      if (!line || !line.length) continue;
      if (line.join('').trim() === '') continue;
      const obj = {};
      for (let c = 0; c < headers.length; c++) obj[headers[c]] = (line[c] ?? '').trim();
      objects.push(obj);
    }
    return objects;
  }

  function getVariantId(row){
    for(const k of VARIANT_ID_CANDIDATES){
      if(row[k] && String(row[k]).trim()) return String(row[k]).trim();
    }
    return '';
  }

  async function loadCSV(){
    setTag(assignStatusEl, 'warn', 'Loading‚Ä¶');
    setTag(lookupStatusEl, 'warn', 'Loading‚Ä¶');
    setTag(modeBadgeEl, 'warn', 'MODE: ‚Äî');
    metaEl.innerHTML = '';
    try{
      const url = CSV_URL + '?v=' + Date.now();
      const res = await fetch(url, { cache: 'no-store' });
      if(!res.ok) throw new Error(`HTTP ${res.status}`);

      const lastModified = res.headers.get('last-modified');
      const etag = res.headers.get('etag');

      const text = await res.text();
      const delim = detectDelimiter(text);
      rows = toObjects(parseCSV(text, delim));

      const sample = rows[0] || {};
      const hasVID = VARIANT_ID_CANDIDATES.some(k => k in sample);
      const hasBarcode = (COL_BARCODE in sample);

      const hasWH = (COL_WH_ONHAND in sample);

      metaEl.innerHTML = `
        <div><strong>CSV file:</strong> <code>${esc(CSV_URL)}</code></div>
        <div><strong>CSV Last Updated (server):</strong> ${lastModified ? esc(new Date(lastModified).toLocaleString()) : '<span style="color:#7f1d1d;">Unknown</span>'}</div>
        <div><strong>Loaded at:</strong> ${esc(new Date().toLocaleString())}</div>
        ${etag ? `<div><strong>ETag:</strong> <code class="mono">${esc(etag)}</code></div>` : ''}
        <div><strong>Rows:</strong> ${rows.length}</div>
        <div><strong>WH On-hand column:</strong> ${hasWH ? '<span class="tag good">Found</span>' : '<span class="tag warn">Not found</span>'} <span class="muted">(uses <span class="mono">${esc(COL_WH_ONHAND)}</span> if present)</span></div>
      `;

      if(!hasVID){
        setTag(assignStatusEl,'bad','Missing Variant ID');
      } else if(!hasBarcode){
        setTag(assignStatusEl,'bad','Missing Variant Barcode');
      } else {
        setTag(assignStatusEl,'good','Ready');
      }
      setTag(lookupStatusEl,'good','Loaded');
      assignHintEl.innerHTML = `<span class="sub">Scan item ‚Üí scan bin ‚Üí done</span>`;
    }catch(e){
      rows = [];
      setTag(assignStatusEl,'bad','CSV load failed');
      setTag(lookupStatusEl,'bad','CSV load failed');
      metaEl.innerHTML = `<div style="color:#7f1d1d;"><strong>Error:</strong> ${esc(e.message)}</div>`;
    }
  }

  function openCSV(){ window.open(CSV_URL, '_blank', 'noopener'); }

  // ========= SMART LOOKUP =========
  function renderLog(){
    scanCountEl.textContent = String(logEntries.length);
    logEl.innerHTML = '';
    for(let i=0;i<logEntries.length;i++){
      const e = logEntries[i];
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${esc(new Date(e.ts).toLocaleTimeString())}</td>
        <td><span class="mono">${esc(e.type||'')}</span></td>
        <td class="mono">${esc(e.bin||'')}</td>
        <td class="mono">${esc(e.barcode||'')}</td>
        <td>${esc(e.title||'')}</td>
        <td><button class="btn" type="button" data-i="${i}">Delete</button></td>
      `;
      tr.querySelector('button').addEventListener('click', (ev)=>{
        const idx = Number(ev.currentTarget.getAttribute('data-i'));
        if(Number.isFinite(idx)) { logEntries.splice(idx,1); renderLog(); }
      });
      logEl.appendChild(tr);
    }
  }
  function clearLog(){ logEntries = []; renderLog(); }
  function undoLastScan(){ if(!logEntries.length) return; logEntries.shift(); renderLog(); }

  function showProductResult(match){
    const vid = getVariantId(match) || '';
    const bin = match[COL_BIN] || '‚Äî';
    const wh = (COL_WH_ONHAND in match) ? nInt(match[COL_WH_ONHAND]) : null;

    setTag(modeBadgeEl, 'good', 'MODE: PRODUCT');

    resultEl.innerHTML = `
      <div class="binBig">${esc(bin)}</div>
      <div style="font-weight:1000;margin-top:4px">${esc(match[COL_TITLE]||'')}</div>

      <div class="kv">
        <div class="pill"><strong>Barcode:</strong> <span class="mono">${esc(match[COL_BARCODE]||'')}</span></div>
        <div class="pill"><strong>SKU:</strong> <span class="mono">${esc(match[COL_SKU]||'')}</span></div>
        <div class="pill"><strong>Variant ID:</strong> <span class="mono">${esc(vid)}</span></div>
        ${wh !== null ? `<div class="pill"><strong>WH On Hand:</strong> <span class="mono">${esc(wh)}</span></div>` : ``}
      </div>

      <div class="sub" style="margin-top:10px">
        <strong>Meaning:</strong> This product should be in bin <span class="mono">${esc(bin)}</span>.
      </div>
    `;
  }

  function showBinResult(binCode, matches){
    setTag(modeBadgeEl, 'warn', 'MODE: BIN');

    // sort for readability: bin then title
    const list = [...matches].sort((a,b)=>{
      const ta = (a[COL_TITLE]||'').toLowerCase();
      const tb = (b[COL_TITLE]||'').toLowerCase();
      return ta.localeCompare(tb);
    });

    const hasWH = list.length ? (COL_WH_ONHAND in list[0]) : false;
    let totalWH = 0;
    if(hasWH){
      list.forEach(r=> totalWH += nInt(r[COL_WH_ONHAND]));
    }

    let html = `
      <div class="binBig">${esc(binCode)}</div>
      <div class="sub" style="margin-top:6px">
        <strong>Meaning:</strong> These are the items the system says are assigned to this bin.
      </div>
      <div class="kv">
        <div class="pill"><strong>Items:</strong> <span class="mono">${esc(list.length)}</span></div>
        ${hasWH ? `<div class="pill"><strong>Total WH On Hand:</strong> <span class="mono">${esc(totalWH)}</span></div>` : ``}
      </div>

      <div style="margin-top:12px; overflow:auto; max-height:45vh">
        <table>
          <thead>
            <tr>
              <th>Title</th>
              <th>SKU</th>
              <th>Item Barcode</th>
              <th>Variant ID</th>
              ${hasWH ? `<th>WH On Hand</th>` : ``}
            </tr>
          </thead>
          <tbody>
    `;

    for(const r of list){
      const vid = getVariantId(r) || '';
      const wh = hasWH ? nInt(r[COL_WH_ONHAND]) : '';
      html += `
        <tr>
          <td>${esc(r[COL_TITLE]||'')}</td>
          <td class="mono">${esc(r[COL_SKU]||'')}</td>
          <td class="mono">${esc(r[COL_BARCODE]||'')}</td>
          <td class="mono">${esc(vid)}</td>
          ${hasWH ? `<td class="mono">${esc(wh)}</td>` : ``}
        </tr>
      `;
    }

    html += `
          </tbody>
        </table>
      </div>
      <div class="sub" style="margin-top:10px">
        <strong>Next step for mismatch capture (manual):</strong> if you scan a BIN and physically see items that are not in this list, those are ‚Äúwrong-bin‚Äù candidates.
      </div>
    `;

    resultEl.innerHTML = html;
  }

  function smartLookup(q){
    if(!rows.length){
      resultEl.innerHTML = `<span class="tag bad">Not ready</span> <span class="sub">Load the CSV first.</span>`;
      setTag(modeBadgeEl, 'warn', 'MODE: ‚Äî');
      return;
    }

    const now = Date.now();
    if (q && lastScan.key === q && (now - lastScan.ts) < DUP_WINDOW_MS){
      lastScan.ts = now;
      return;
    }
    lastScan = { key:q, ts:now };

    // 1) BIN MODE if any row has this exact bin
    const binMatches = rows.filter(r => (r[COL_BIN] || '').trim() === q);
    if(binMatches.length){
      showBinResult(q, binMatches);
      logEntries.unshift({
        ts: now,
        type: 'BIN',
        bin: q,
        barcode: '',
        title: `${binMatches.length} items`
      });
      renderLog();
      return;
    }

    // 2) PRODUCT MODE (barcode or sku)
    const m = rows.find(r =>
      (r[COL_BARCODE] && r[COL_BARCODE]===q) ||
      (r[COL_SKU] && r[COL_SKU]===q)
    );

    if(!m){
      setTag(modeBadgeEl, 'bad', 'MODE: NOT FOUND');
      resultEl.innerHTML = `<span class="tag bad">Not found</span> <span class="sub">Scan a BIN code, barcode, or SKU again.</span>`;
      return;
    }

    showProductResult(m);

    logEntries.unshift({
      ts: now,
      type: 'PRODUCT',
      bin: m[COL_BIN] || '',
      barcode: m[COL_BARCODE] || '',
      title: m[COL_TITLE] || ''
    });
    renderLog();
  }

  document.getElementById('scan').addEventListener('keydown', e=>{
    if(e.key==='Enter'){
      const q = e.target.value.trim();
      e.target.value='';
      smartLookup(q);
      setTimeout(()=>document.getElementById('scan').focus(), 50);
    }
  });

  // ========= ASSIGNMENT =========
  function findRowByScan(q){
    if(!rows.length) return null;
    return rows.find(r =>
      (r[COL_BARCODE] && r[COL_BARCODE]===q) ||
      (r[COL_SKU] && r[COL_SKU]===q)
    ) || null;
  }

  function renderAssignments(){
    const has = assignments.length > 0;
    dlShopifyBtn.disabled = !has;
    dlLabelsBtn.disabled = !has;
    dlRawBtn.disabled = !has;

    assignTableEl.innerHTML = '';
    assignments.forEach((a, i)=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${i+1}</td>
        <td class="mono">${esc(a.variantId)}</td>
        <td class="mono">${esc(a.itemBarcode)}</td>
        <td class="mono">${esc(a.sku)}</td>
        <td>${esc(a.title)}</td>
        <td><input class="cellInput" value="${esc(a.bin||'')}" data-i="${i}" placeholder="(blank OK for Excel)" /></td>
        <td><button class="btn" type="button" data-i="${i}">Delete</button></td>
      `;

      tr.querySelector('input').addEventListener('input', (ev)=>{
        const idx = Number(ev.currentTarget.getAttribute('data-i'));
        if(!Number.isFinite(idx)) return;
        assignments[idx].bin = ev.currentTarget.value;
      });

      tr.querySelector('button').addEventListener('click', (ev)=>{
        const idx = Number(ev.currentTarget.getAttribute('data-i'));
        if(Number.isFinite(idx)) { assignments.splice(idx,1); renderAssignments(); }
      });

      assignTableEl.appendChild(tr);
    });

    if(assignments.length){
      const last = assignments[assignments.length-1];
      const binTxt = (last.bin && last.bin.trim()) ? ` ‚Üí <span class="mono">${esc(last.bin)}</span>` : ` ‚Üí <span class="mono">(bin blank)</span>`;
      assignPreviewEl.innerHTML = `<span class="tag good">Added</span> <span class="sub">${esc(last.title)}${binTxt}</span>`;
    } else {
      assignPreviewEl.textContent = '';
    }
  }

  function addAssignmentCore(scanVal, binVal){
    if(!rows.length){ setTag(assignStatusEl,'bad','CSV not loaded'); return false; }
    if(!scanVal){ setTag(assignStatusEl,'warn','Scan item'); return false; }

    const row = findRowByScan(scanVal);
    if(!row){ setTag(assignStatusEl,'bad','Not found'); return false; }

    const variantId = getVariantId(row);
    if(!variantId){ setTag(assignStatusEl,'bad','No Variant ID'); return false; }

    const itemBarcode = String(row[COL_BARCODE]||'').trim();
    if(!itemBarcode){ setTag(assignStatusEl,'bad','No item barcode'); return false; }

    assignments.push({
      variantId,
      itemBarcode,
      sku: String(row[COL_SKU]||'').trim(),
      title: String(row[COL_TITLE]||'').trim(),
      bin: binVal || ''
    });

    setTag(assignStatusEl,'good','Ready');
    renderAssignments();
    return true;
  }

  function addAssignmentFromButtons(){
    const scanVal = assignScanEl.value.trim();
    const binVal = assignBinEl.value.trim();
    const ok = addAssignmentCore(scanVal, binVal);
    if(!ok) return;

    assignScanEl.value = '';
    assignBinEl.value = '';
    assignScanEl.focus();
  }

  // Fast flow: item Enter -> if bin empty, focus bin; else add
  assignScanEl.addEventListener('keydown', (e)=>{
    if(e.key === 'Enter'){
      const scanVal = assignScanEl.value.trim();
      if(!scanVal) return;

      if(!assignBinEl.value.trim()){
        e.preventDefault();
        assignBinEl.focus();
        return;
      }

      e.preventDefault();
      const ok = addAssignmentCore(scanVal, assignBinEl.value.trim());
      if(!ok) return;

      assignScanEl.value = '';
      assignBinEl.value = '';
      assignScanEl.focus();
    }
  });

  // Bin Enter adds (bin can be blank)
  assignBinEl.addEventListener('keydown', (e)=>{
    if(e.key === 'Enter'){
      e.preventDefault();
      const scanVal = assignScanEl.value.trim();
      const binVal = assignBinEl.value.trim();
      const ok = addAssignmentCore(scanVal, binVal);
      if(!ok) return;

      assignScanEl.value = '';
      assignBinEl.value = '';
      assignScanEl.focus();
    }
  });

  function clearAssignments(){
    if(!assignments.length) return;
    if(!confirm('Clear the assignment list?')) return;
    assignments = [];
    renderAssignments();
    assignScanEl.value = '';
    assignBinEl.value = '';
    assignScanEl.focus();
  }

  function csvEscape(s){
    s = String(s ?? '');
    return /[",\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
  }

  function makeFilename(prefix){
    const d = new Date();
    const pad = (x)=>String(x).padStart(2,'0');
    return `${prefix}_${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}_${pad(d.getHours())}${pad(d.getMinutes())}.csv`;
  }

  function downloadText(name, text){
    const blob = new Blob([text], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = name;
    a.click();
    URL.revokeObjectURL(url);
  }

  // Export A: Shopify bin upload
  function downloadShopifyBinsCSV(){
    if(!assignments.length) return;

    const H_VARIANT_ID = 'Variant ID';
    const H_BIN = 'Variant Metafield: custom.wh_bin [single_line_text_field]';

    let csv = `${H_VARIANT_ID},${H_BIN}\n`;
    assignments.forEach(a=>{
      csv += `${csvEscape(a.variantId)},${csvEscape(a.bin || '')}\n`;
    });

    downloadText(makeFilename('SHOPIFY_BIN_UPLOAD'), csv);
  }

  // Export B: Label print CSV (alternating)
  function downloadLabelPrintCSV(){
    if(!assignments.length) return;

    // label_type,line1,line2,barcode
    let csv = 'label_type,line1,line2,barcode\n';

    assignments.forEach(a=>{
      const bin = (a.bin || '').trim();

      // BIN label only if bin exists
      if(bin){
        csv += `BIN,${csvEscape(bin)},${csvEscape('WH')},${csvEscape(bin)}\n`;
      }

      // ITEM label
      const title = a.title || '';
      const skuPart = a.sku ? `SKU: ${a.sku}` : '';
      const binPart = bin ? `Bin: ${bin}` : 'Bin: (blank)';
      const line2 = skuPart ? `${skuPart} | ${binPart}` : binPart;

      csv += `ITEM,${csvEscape(title)},${csvEscape(line2)},${csvEscape(a.itemBarcode)}\n`;
    });

    downloadText(makeFilename('LABEL_PRINT'), csv);
  }

  // Export C: Raw assignment CSV
  function downloadAssignmentsRawCSV(){
    if(!assignments.length) return;

    let csv = 'variant_id,item_barcode,sku,title,wh_bin\n';
    assignments.forEach(a=>{
      csv += `${csvEscape(a.variantId)},${csvEscape(a.itemBarcode)},${csvEscape(a.sku)},${csvEscape(a.title)},${csvEscape(a.bin || '')}\n`;
    });

    downloadText(makeFilename('ASSIGNMENT_RAW'), csv);
  }

  // boot
  loadCSV();

  // service worker
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('../sw.js').catch(()=>{});
    });
  }
</script>

</body>
</html>
