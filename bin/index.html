<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Livewell ‚Äì Bin Assignment</title>

<link rel="manifest" href="../manifest.json">
<meta name="theme-color" content="#0f172a">

<style>
:root{
  --bg:#f7f9fc; --card:#fff; --text:#0f172a; --muted:#475569; --line:#e2e8f0;
  --goodbg:#dcfce7; --good:#166534; --badbg:#fee2e2; --bad:#7f1d1d;
  --warnbg:#fff7ed; --warn:#9a3412;
  --blue:#1d4ed8; --blue2:#2563eb;
}
body{font-family:system-ui,-apple-system,Segoe UI,Roboto;background:var(--bg);margin:0;padding:18px;color:var(--text)}
.wrap{max-width:1100px;margin:0 auto}

.topnav{
  position:sticky; top:0; z-index:50;
  background:#fff;border:1px solid var(--line);
  border-radius:14px;padding:10px;margin-bottom:14px;
  box-shadow:0 2px 10px rgba(0,0,0,.05);
}
.topnav .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.topnav a{text-decoration:none}
.topnav button{
  padding:8px 14px;border-radius:10px;border:1px solid #d1d5db;
  font-weight:900;cursor:pointer;background:#fff;
}
.topnav button.active{background:#0f172a;color:#fff;border-color:#0f172a}
.topnav .spacer{flex:1}
.small{font-size:12px;color:var(--muted);font-weight:900}

h1{margin:6px 0 6px;font-size:34px}
.sub{margin:6px 0 0;color:var(--muted);font-size:13px;line-height:1.35}

.card{
  background:var(--card);
  border-radius:16px;
  padding:16px;
  margin-bottom:14px;
  box-shadow:0 2px 10px rgba(0,0,0,.06);
  border:1px solid rgba(226,232,240,.7);
}

.row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}

.btn{
  padding:10px 12px;border-radius:12px;border:1px solid var(--line);
  font-weight:900;cursor:pointer;background:#fff;
}
.btnPrimary{background:var(--blue);border-color:var(--blue);color:#fff}
.btnDanger{background:#7f1d1d;border-color:#7f1d1d;color:#fff}
.btn:disabled{opacity:.45;cursor:not-allowed}

input.big{
  font-size:24px;padding:12px 14px;width:100%;
  border-radius:14px;border:1px solid #cbd5e1;box-sizing:border-box
}
input.med{
  font-size:18px;padding:10px 12px;border-radius:12px;
  border:1px solid #cbd5e1;width:320px;max-width:100%;
  box-sizing:border-box
}

table{width:100%;border-collapse:collapse;font-size:14px}
th,td{padding:10px;border-bottom:1px solid var(--line);text-align:left}
tbody tr:nth-child(even){background:#f9fafb}
.mono{font-family:ui-monospace, monospace}

.cellInput{
  width:100%;padding:8px 10px;border-radius:10px;
  border:1px solid #cbd5e1;font-weight:900;
}
</style>
</head>

<body>
<div class="wrap">

<!-- NAV -->
<div class="topnav">
  <div class="row">
    <a href="../index.html"><button>üè† Home</button></a>
    <a href="../Picks/index.html"><button>üìã Picks</button></a>
    <a href="../putaway/index.html"><button>üì¶ Putaway</button></a>
    <a href="../bin/index.html"><button class="active">üìç Bin</button></a>
    <a href="../bin-check/index.html"><button>üìå Bin Checker</button></a>
    <a href="../manual/index.html"><button>üìò Manual</button></a>
    <div class="spacer"></div>
    <div class="small">Ops Tools</div>
  </div>
</div>

<h1>Bin Assignment</h1>
<p class="sub">
Scan items and assign warehouse bins.  
This page only builds CSV exports ‚Äî it does NOT modify Shopify until upload.
</p>

<div class="card">

<div class="row">
  <div style="flex:1;min-width:260px">
    <div class="small">Scan item (barcode or SKU)</div>
    <input id="assignScan" class="big" placeholder="Scan item + Enter" autofocus />
  </div>

  <div style="min-width:280px">
    <div class="small">Bin value (optional)</div>
    <input id="assignBin" class="med mono" placeholder="Scan/type bin + Enter" />
  </div>

  <button class="btn btnPrimary" onclick="addAssignment()">Add</button>
  <button class="btn btnDanger" onclick="clearAssignments()">Clear</button>
</div>

<div style="margin-top:14px;overflow:auto;max-height:45vh">
<table>
<thead>
<tr>
<th>#</th>
<th>Variant ID</th>
<th>Barcode</th>
<th>SKU</th>
<th>Title</th>
<th>WH Bin</th>
<th></th>
</tr>
</thead>
<tbody id="assignTable"></tbody>
</table>
</div>

<div class="row" style="margin-top:14px">
<button class="btn" onclick="downloadShopifyCSV()">Shopify Bin Upload CSV</button>
<button class="btn" onclick="downloadLabelCSV()">Label Print CSV</button>
<button class="btn" onclick="downloadRawCSV()">Raw Assignment CSV</button>
</div>

</div>
</div>

<script>
const CSV_URL = '../pickle-data.csv';
const COL_BARCODE = 'Variant Barcode';
const COL_SKU = 'Variant SKU';
const COL_TITLE = 'Title';
const COL_BIN = 'Variant Metafield: custom.wh_bin [single_line_text_field]';

const VARIANT_ID_CANDIDATES = [
'Variant ID','Variant Id','variant_id','variant id'
];

let rows = [];
let assignments = [];

function getVariantId(row){
for(const k of VARIANT_ID_CANDIDATES){
if(row[k]) return row[k];
}
return '';
}

async function loadCSV(){
const res = await fetch(CSV_URL + '?v=' + Date.now());
const text = await res.text();
const lines = text.split('\n');
const headers = lines[0].split(',');
rows = lines.slice(1).map(l=>{
const cols = l.split(',');
let obj = {};
headers.forEach((h,i)=>obj[h.trim()] = (cols[i]||'').trim());
return obj;
});
}
loadCSV();

function findRow(q){
return rows.find(r =>
r[COL_BARCODE]===q || r[COL_SKU]===q
);
}

function addAssignment(){
const scan = document.getElementById('assignScan').value.trim();
const bin = document.getElementById('assignBin').value.trim();
if(!scan) return;

const row = findRow(scan);
if(!row) return alert("Not found");

assignments.push({
variantId: getVariantId(row),
barcode: row[COL_BARCODE],
sku: row[COL_SKU],
title: row[COL_TITLE],
bin: bin
});

render();
document.getElementById('assignScan').value='';
document.getElementById('assignBin').value='';
document.getElementById('assignScan').focus();
}

function render(){
const tbody = document.getElementById('assignTable');
tbody.innerHTML='';
assignments.forEach((a,i)=>{
tbody.innerHTML += `
<tr>
<td>${i+1}</td>
<td class="mono">${a.variantId}</td>
<td class="mono">${a.barcode}</td>
<td class="mono">${a.sku}</td>
<td>${a.title}</td>
<td><input class="cellInput" value="${a.bin||''}" onchange="assignments[${i}].bin=this.value"></td>
<td><button onclick="assignments.splice(${i},1);render()">Delete</button></td>
</tr>`;
});
}

function clearAssignments(){
if(!confirm("Clear list?")) return;
assignments=[];
render();
}

function csvEscape(s){
return `"${(s||'').replace(/"/g,'""')}"`;
}

function downloadFile(name,text){
const blob = new Blob([text],{type:'text/csv'});
const url = URL.createObjectURL(blob);
const a=document.createElement('a');
a.href=url;a.download=name;a.click();
URL.revokeObjectURL(url);
}

function downloadShopifyCSV(){
let csv="Variant ID,Variant Metafield: custom.wh_bin [single_line_text_field]\n";
assignments.forEach(a=>{
csv+=`${a.variantId},${a.bin||''}\n`;
});
downloadFile("SHOPIFY_BIN_UPLOAD.csv",csv);
}

function downloadLabelCSV(){
let csv="label_type,line1,line2,barcode\n";
assignments.forEach(a=>{
if(a.bin) csv+=`BIN,${a.bin},WH,${a.bin}\n`;
csv+=`ITEM,${csvEscape(a.title)},SKU: ${a.sku},${a.barcode}\n`;
});
downloadFile("LABEL_PRINT.csv",csv);
}

function downloadRawCSV(){
let csv="variant_id,barcode,sku,title,wh_bin\n";
assignments.forEach(a=>{
csv+=`${a.variantId},${a.barcode},${a.sku},${csvEscape(a.title)},${a.bin}\n`;
});
downloadFile("ASSIGNMENT_RAW.csv",csv);
}
</script>

</body>
</html>
