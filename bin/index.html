<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Bin Lookup</title>

<link rel="manifest" href="../manifest.json">
<meta name="theme-color" content="#0f172a">

<style>
  :root{
    --bg:#f7f9fc; --card:#fff; --text:#0f172a; --muted:#475569; --line:#e2e8f0;
    --goodbg:#dcfce7; --good:#166534; --badbg:#fee2e2; --bad:#7f1d1d;
    --blue:#1d4ed8; --blue2:#2563eb;
  }
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto;background:var(--bg);margin:0;padding:18px;color:var(--text)}
  .wrap{max-width:1100px;margin:0 auto}
  .topnav{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:14px}
  .topnav a{display:inline-block;text-decoration:none;font-weight:900;color:var(--text);
    padding:10px 12px;border:1px solid var(--line);border-radius:12px;background:#fff}
  .topnav a:hover{background:#f1f5f9}
  h1{margin:6px 0 6px;font-size:34px}
  .sub{margin:0 0 14px;color:var(--muted);font-size:13px;line-height:1.35}
  .card{background:var(--card);border-radius:16px;padding:16px;margin-bottom:14px;
    box-shadow:0 2px 10px rgba(0,0,0,.06);border:1px solid rgba(226,232,240,.7)}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  .badge{display:inline-block;padding:2px 10px;border-radius:999px;font-size:12px;font-weight:900;vertical-align:middle}
  .good{background:var(--goodbg);color:var(--good)}
  .bad{background:var(--badbg);color:var(--bad)}
  code{background:#f3f4f6;padding:2px 6px;border-radius:8px}
  .btn{padding:10px 12px;border-radius:12px;border:1px solid var(--line);font-weight:900;cursor:pointer;background:#fff}
  .btn:active{transform:translateY(1px)}
  .btnPrimary{background:var(--blue);border-color:var(--blue);color:#fff}
  .btnPrimary:hover{background:var(--blue2)}
  input{font-size:26px;padding:14px 14px;width:100%;border-radius:14px;border:1px solid #cbd5e1;box-sizing:border-box}
  .resultWrap{min-height:110px}
  .bin{font-size:64px;font-weight:1000;margin:6px 0 0;letter-spacing:1px}
  table{width:100%;border-collapse:collapse;font-size:14px}
  th,td{padding:10px;border-bottom:1px solid var(--line);text-align:left;vertical-align:top}
  tbody tr:nth-child(even){background:#f9fafb}
  .pill{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:2px 8px;font-size:12px;font-weight:900;color:#111;background:#fff}
  .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
</style>
</head>

<body>
<div class="wrap">

  <nav class="topnav">
    <a href="../">üè† Home</a>
    <a href="../bin/">üìç Bin Lookup</a>
    <a href="../picks/">üì¶ Picks</a>
    <a href="../putaway/">üßæ Scan + Putaway</a>
  </nav>

  <h1>Bin Lookup</h1>
  <p class="sub">
    Scan a barcode or SKU to see the warehouse bin. This auto-loads <code>pickle-data.csv</code> from the repo.
    Tip: if you double-scan by accident, use <span class="pill">Undo Last Scan</span>.
  </p>

  <div class="card">
    <div id="status"><span class="badge bad">Not loaded</span> Waiting‚Ä¶</div>
    <div id="meta" class="sub" style="margin-top:8px"></div>

    <div class="row" style="margin-top:10px">
      <button class="btn" type="button" onclick="loadCSV()">Reload from site</button>
      <button class="btn" type="button" onclick="openCSV()">Open CSV</button>
      <button class="btn" type="button" onclick="undoLastScan()">Undo Last Scan</button>
      <button class="btn" type="button" onclick="clearLog()">Clear Log</button>
    </div>

    <div class="sub" style="margin-top:10px">
      Scans this session: <strong id="scanCount">0</strong>
    </div>
  </div>

  <div class="card">
    <input id="scan" placeholder="Scan barcode or SKU and press Enter" autofocus />
    <div id="result" class="resultWrap" style="margin-top:12px"></div>
  </div>

  <div class="card">
    <div style="font-weight:1000;margin-bottom:6px">Scan Log</div>
    <div class="sub" style="margin-top:0">Newest first. Click Delete if you need to remove a specific line.</div>

    <div style="overflow:auto; max-height:60vh">
      <table>
        <thead><tr><th>Time</th><th>Bin</th><th>Barcode</th><th>Title</th><th>Actions</th></tr></thead>
        <tbody id="log"></tbody>
      </table>
    </div>
  </div>

</div>

<script>
  const CSV_URL = '../pickle-data.csv';

  // headers
  const COL_BARCODE = 'Variant Barcode';
  const COL_SKU = 'Variant SKU';
  const COL_TITLE = 'Title';
  const COL_BIN = 'Variant Metafield: custom.wh_bin [single_line_text_field]';

  // duplicate protection window (ms)
  const DUP_WINDOW_MS = 2000;

  let rows = [];
  let logEntries = []; // {ts, bin, barcode, title}
  let lastScan = { key:'', ts:0 };

  const statusEl = document.getElementById('status');
  const metaEl = document.getElementById('meta');
  const resultEl = document.getElementById('result');
  const logEl = document.getElementById('log');
  const scanCountEl = document.getElementById('scanCount');

  function esc(s){
    return String(s ?? '')
      .replace(/&/g,'&amp;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;');
  }
  function setStatus(ok, msg){
    statusEl.innerHTML = `<span class="badge ${ok ? 'good' : 'bad'}">${ok ? 'Loaded' : 'Failed'}</span> ${msg}`;
  }
  function fmtDate(d){ try{ return new Date(d).toLocaleString(); }catch{ return String(d||''); } }

  function setMeta(html){ metaEl.innerHTML = html || ''; }

  // CSV parsing (robust)
  function detectDelimiter(text) {
    const firstLine = (text.split(/\r?\n/).find(l => l.trim() !== '') || '');
    const candidates = [',',';','\t','|'];
    let best = ',', bestCount = -1;
    for (const d of candidates) {
      const c = firstLine.split(d).length;
      if (c > bestCount) { bestCount = c; best = d; }
    }
    return best;
  }
  function parseCSV(text, delimiter) {
    const out = [];
    let i = 0, field = '', row = [], inQuotes = false;
    if (text.charCodeAt(0) === 0xFEFF) text = text.slice(1);

    while (i < text.length) {
      const c = text[i];
      if (c === '"') {
        if (inQuotes && text[i+1] === '"') { field += '"'; i++; }
        else { inQuotes = !inQuotes; }
      } else if (c === delimiter && !inQuotes) {
        row.push(field); field = '';
      } else if ((c === '\n' || c === '\r') && !inQuotes) {
        if (field !== '' || row.length) { row.push(field); out.push(row); row = []; field = ''; }
        if (c === '\r' && text[i+1] === '\n') i++;
      } else {
        field += c;
      }
      i++;
    }
    if (field !== '' || row.length) { row.push(field); out.push(row); }
    return out;
  }
  function toObjects(matrix) {
    if (!matrix.length) return [];
    const headers = (matrix[0] || []).map(h => String(h ?? '').trim());
    const objects = [];
    for (let r = 1; r < matrix.length; r++) {
      const line = matrix[r];
      if (!line || !line.length) continue;
      if (line.join('').trim() === '') continue;
      const obj = {};
      for (let c = 0; c < headers.length; c++) obj[headers[c]] = (line[c] ?? '').trim();
      objects.push(obj);
    }
    return objects;
  }

  async function loadCSV(){
    setStatus(false, 'Loading‚Ä¶');
    setMeta('');
    try{
      const url = CSV_URL + '?v=' + Date.now();
      const res = await fetch(url, { cache: 'no-store' });
      if(!res.ok) throw new Error(`HTTP ${res.status}`);

      const lastModified = res.headers.get('last-modified');
      const etag = res.headers.get('etag');

      const text = await res.text();
      const delim = detectDelimiter(text);
      rows = toObjects(parseCSV(text, delim));

      setStatus(true, `Parsed ${rows.length} rows`);
      setMeta(`
        <div><strong>CSV file:</strong> <code>${esc(CSV_URL)}</code></div>
        <div><strong>CSV Last Updated (server):</strong> ${lastModified ? fmtDate(lastModified) : '<span style="color:#7f1d1d;">Unknown</span>'}</div>
        <div><strong>Loaded at (this device):</strong> ${new Date().toLocaleString()}</div>
        ${etag ? `<div><strong>ETag:</strong> <code class="mono">${esc(etag)}</code></div>` : ''}
      `);
    }catch(e){
      rows = [];
      setStatus(false, `Couldn‚Äôt load <code>${esc(CSV_URL)}</code> ‚Äî ${esc(e.message)}`);
      setMeta(`<div style="color:#7f1d1d;"><strong>Tip:</strong> Open <code>${esc(CSV_URL)}</code> in a browser tab to confirm it exists.</div>`);
    }
  }

  function openCSV(){ window.open(CSV_URL, '_blank', 'noopener'); }

  function renderLog(){
    scanCountEl.textContent = String(logEntries.length);
    logEl.innerHTML = '';
    for(let i=0;i<logEntries.length;i++){
      const e = logEntries[i];
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${esc(new Date(e.ts).toLocaleTimeString())}</td>
        <td class="mono">${esc(e.bin||'')}</td>
        <td class="mono">${esc(e.barcode||'')}</td>
        <td>${esc(e.title||'')}</td>
        <td><button class="btn" type="button" data-i="${i}">Delete</button></td>
      `;
      tr.querySelector('button').addEventListener('click', (ev)=>{
        const idx = Number(ev.currentTarget.getAttribute('data-i'));
        if(Number.isFinite(idx)) { logEntries.splice(idx,1); renderLog(); }
      });
      logEl.appendChild(tr);
    }
  }

  function clearLog(){
    logEntries = [];
    renderLog();
  }

  function undoLastScan(){
    if(!logEntries.length) return;
    logEntries.shift(); // newest first
    renderLog();
  }

  function showResult(match){
    resultEl.innerHTML = `
      <div class="bin">${esc(match[COL_BIN]||'‚Äî')}</div>
      <div style="font-weight:1000;margin-top:4px">${esc(match[COL_TITLE]||'')}</div>
      <div class="sub" style="margin-top:6px">
        <strong>Barcode:</strong> <span class="mono">${esc(match[COL_BARCODE]||'')}</span>
        &nbsp; | &nbsp;
        <strong>SKU:</strong> <span class="mono">${esc(match[COL_SKU]||'')}</span>
      </div>
    `;
  }

  function lookup(q){
    if(!rows.length){
      resultEl.innerHTML = `<span class="badge bad">Not ready</span> <span class="sub">Load the CSV first.</span>`;
      return;
    }

    const now = Date.now();
    if (q && lastScan.key === q && (now - lastScan.ts) < DUP_WINDOW_MS){
      // ignore accidental double scan (common with kiosk scanners)
      lastScan.ts = now;
      return;
    }
    lastScan = { key:q, ts:now };

    const m = rows.find(r =>
      (r[COL_BARCODE] && r[COL_BARCODE]===q) ||
      (r[COL_SKU] && r[COL_SKU]===q)
    );

    if(!m){
      resultEl.innerHTML = `<span class="badge bad">Not found</span> <span class="sub">Try scanning barcode or SKU again.</span>`;
      return;
    }

    showResult(m);

    logEntries.unshift({
      ts: now,
      bin: m[COL_BIN] || '',
      barcode: m[COL_BARCODE] || '',
      title: m[COL_TITLE] || ''
    });
    renderLog();
  }

  document.getElementById('scan').addEventListener('keydown', e=>{
    if(e.key==='Enter'){
      const q = e.target.value.trim();
      e.target.value='';
      lookup(q);
      setTimeout(()=>document.getElementById('scan').focus(), 50);
    }
  });

  // boot
  loadCSV();
</script>

<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('../sw.js').catch(()=>{});
    });
  }
</script>

</body>
</html>
