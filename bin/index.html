<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Bin Utility</title>

<link rel="manifest" href="../manifest.json">
<meta name="theme-color" content="#0f172a">

<style>
  :root{
    --bg:#f7f9fc; --card:#fff; --text:#0f172a; --muted:#475569; --line:#e2e8f0;
    --goodbg:#dcfce7; --good:#166534; --badbg:#fee2e2; --bad:#7f1d1d;
    --warnbg:#fff7ed; --warn:#9a3412;
    --blue:#1d4ed8; --blue2:#2563eb;
  }
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto;background:var(--bg);margin:0;padding:18px;color:var(--text)}
  .wrap{max-width:1100px;margin:0 auto}

  /* NAV */
  .topnav{
    position:sticky; top:0; z-index:50;
    background:#fff;
    border:1px solid var(--line);
    border-radius:14px;
    padding:10px;
    margin-bottom:14px;
    box-shadow:0 2px 10px rgba(0,0,0,.05);
  }
  .topnav .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .topnav a{text-decoration:none}
  .topnav button{
    padding:8px 14px;border-radius:10px;border:1px solid #d1d5db;
    font-weight:900;cursor:pointer;background:#fff;
  }
  .topnav button.active{background:#0f172a;color:#fff;border-color:#0f172a}
  .topnav .spacer{flex:1}
  .small{font-size:12px;color:var(--muted);font-weight:900}

  h1{margin:6px 0 6px;font-size:34px}
  h2{margin:0 0 8px;font-size:20px}
  .sub{margin:0 0 14px;color:var(--muted);font-size:13px;line-height:1.35}

  .card{background:var(--card);border-radius:16px;padding:16px;margin-bottom:14px;
    box-shadow:0 2px 10px rgba(0,0,0,.06);border:1px solid rgba(226,232,240,.7)}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}

  .badge{display:inline-block;padding:3px 10px;border-radius:999px;font-size:12px;font-weight:900;vertical-align:middle;border:1px solid var(--line);background:#f8fafc}
  .good{background:var(--goodbg);color:var(--good);border-color:#86efac}
  .bad{background:var(--badbg);color:var(--bad);border-color:#fecaca}
  .warn{background:var(--warnbg);color:var(--warn);border-color:#fed7aa}

  code{background:#f3f4f6;padding:2px 6px;border-radius:8px}

  .btn{padding:10px 12px;border-radius:12px;border:1px solid var(--line);font-weight:900;cursor:pointer;background:#fff}
  .btn:active{transform:translateY(1px)}
  .btnPrimary{background:var(--blue);border-color:var(--blue);color:#fff}
  .btnPrimary:hover{background:var(--blue2)}
  .btnDanger{background:#7f1d1d;border-color:#7f1d1d;color:#fff}

  input.big{font-size:24px;padding:12px 14px;width:100%;border-radius:14px;border:1px solid #cbd5e1;box-sizing:border-box}
  input.med{font-size:18px;padding:10px 12px;border-radius:12px;border:1px solid #cbd5e1;width:320px;max-width:100%;box-sizing:border-box}

  .resultWrap{min-height:90px}
  .binBig{font-size:56px;font-weight:1000;margin:6px 0 0;letter-spacing:1px}

  table{width:100%;border-collapse:collapse;font-size:14px}
  th,td{padding:10px;border-bottom:1px solid var(--line);text-align:left;vertical-align:top}
  tbody tr:nth-child(even){background:#f9fafb}
  .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
  .pill{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:2px 8px;font-size:12px;font-weight:900;color:#111;background:#fff}

  .cellInput{
    width:100%;
    box-sizing:border-box;
    padding:8px 10px;
    border-radius:10px;
    border:1px solid #cbd5e1;
    font-weight:900;
    font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    background:#fff;
  }
</style>
</head>

<body>
<div class="wrap">

  <!-- NAV -->
  <div class="topnav">
    <div class="row">
      <a href="../index.html"><button>üè† Home</button></a>
      <a href="../Picks/index.html"><button>üìã Picks</button></a>
      <a href="../putaway/index.html"><button>üì¶ Putaway</button></a>
      <a href="../bin/index.html"><button class="active">üìç Bin</button></a>
      <div class="spacer"></div>
      <div class="small">Ops Tools</div>
    </div>
  </div>

  <h1>Bin</h1>
  <p class="sub">
    Uses <code>pickle-data.csv</code>. Bin Assignment exports:
    (1) Shopify bin upload CSV (Variant ID + bin metafield),
    and (2) Label print CSV (BIN label then ITEM label alternating).
    <strong>Do not upload blank bins to Shopify</strong> unless you intend to clear bins.
  </p>

  <!-- =======================
       BIN ASSIGNMENT (TOP)
       ======================= -->
  <div class="card">
    <div class="row" style="justify-content:space-between;align-items:flex-start">
      <div style="min-width:260px;flex:1">
        <h2>Bin Assignment (Scan ‚Üí CSV)</h2>

        <div class="sub" style="margin:0">
          <strong>How this works:</strong><br><br>

          1) Scan an item (barcode or SKU) and press Enter.<br>
          2) If the Bin field is empty, the cursor automatically moves to the Bin field.<br>
          3) Scan or type the bin value and press Enter.<br>
          4) The row is added in scan order and the cursor returns to the Item field.<br><br>

          ‚Ä¢ If the Bin field already has a value, pressing Enter on the Item field will add the row immediately.<br>
          ‚Ä¢ Bin is optional ‚Äî you may leave it blank if generating sequential bins later in Excel.<br>
          ‚Ä¢ <strong>Important:</strong> uploading blank bins to Shopify will clear bin locations.<br><br>

          <strong>Exports:</strong><br>
          ‚Ä¢ <span class="mono">Shopify Bin Upload</span> = Variant ID + bin metafield only<br>
          ‚Ä¢ <span class="mono">Label Print</span> = alternating BIN label (bin text + bin barcode) then ITEM label (title + item barcode)
        </div>
      </div>

      <div style="min-width:240px;text-align:right">
        <div id="assignStatus" class="badge warn">Waiting for CSV‚Ä¶</div>
        <div id="assignHint" class="sub" style="margin-top:8px"></div>
      </div>
    </div>

    <div class="row" style="margin-top:12px;align-items:flex-end">
      <div style="flex:1;min-width:260px">
        <div class="small">Scan item (barcode or SKU)</div>
        <input id="assignScan" class="big" placeholder="Scan item + Enter" autofocus />
      </div>

      <div style="min-width:280px">
        <div class="small">Bin value (optional)</div>
        <input id="assignBin" class="med mono" placeholder="Scan/type bin (optional) + Enter" />
      </div>

      <button class="btn btnPrimary" type="button" onclick="addAssignmentFromButtons()">Add</button>

      <button class="btn" type="button" onclick="downloadShopifyBinsCSV()" id="dlShopifyBtn" disabled>Shopify Bin Upload</button>
      <button class="btn" type="button" onclick="downloadLabelPrintCSV()" id="dlLabelsBtn" disabled>Label Print CSV</button>

      <button class="btn btnDanger" type="button" onclick="clearAssignments()">Clear</button>
    </div>

    <div id="assignPreview" class="sub" style="margin-top:10px"></div>

    <div style="overflow:auto; max-height:45vh; margin-top:8px">
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Variant ID</th>
            <th>Item Barcode</th>
            <th>SKU</th>
            <th>Title</th>
            <th>WH Bin (editable)</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="assignTable"></tbody>
      </table>
    </div>

    <div class="sub" style="margin-top:10px">
      <strong>Barcode behavior:</strong> Bin label barcode = bin value. Item label barcode = <span class="mono">Variant Barcode</span>.
      Both intended for Code 128 barcodes in label software.
    </div>
  </div>

  <!-- =======================
       BIN LOOKUP (BELOW)
       ======================= -->
  <div class="card">
    <div id="status"><span class="badge bad">Not loaded</span> Waiting‚Ä¶</div>
    <div id="meta" class="sub" style="margin-top:8px"></div>

    <div class="row" style="margin-top:10px">
      <button class="btn" type="button" onclick="loadCSV()">Reload from site</button>
      <button class="btn" type="button" onclick="openCSV()">Open CSV</button>
      <button class="btn" type="button" onclick="undoLastScan()">Undo Last Scan</button>
      <button class="btn" type="button" onclick="clearLog()">Clear Log</button>
    </div>

    <div class="sub" style="margin-top:10px">
      Scans this session: <strong id="scanCount">0</strong>
    </div>
  </div>

  <div class="card">
    <input id="scan" class="big" placeholder="Scan barcode or SKU and press Enter" />
    <div id="result" class="resultWrap" style="margin-top:12px"></div>
  </div>

  <div class="card">
    <div style="font-weight:1000;margin-bottom:6px">Scan Log</div>
    <div class="sub" style="margin-top:0">Newest first. Click Delete if you need to remove a specific line.</div>

    <div style="overflow:auto; max-height:60vh">
      <table>
        <thead><tr><th>Time</th><th>Bin</th><th>Barcode</th><th>Title</th><th>Actions</th></tr></thead>
        <tbody id="log"></tbody>
      </table>
    </div>
  </div>

</div>

<script>
  const CSV_URL = '../pickle-data.csv';

  // headers in pickle-data.csv (Shopify export)
  const COL_BARCODE = 'Variant Barcode'; // item barcode for ITEM label
  const COL_SKU = 'Variant SKU';
  const COL_TITLE = 'Title';
  const COL_BIN = 'Variant Metafield: custom.wh_bin [single_line_text_field]';

  // Variant ID candidates (master id)
  const VARIANT_ID_CANDIDATES = [
    'Variant ID','Variant Id','variant_id','variant id','VariantID',
    'Variant: ID','Variant: Id'
  ];

  // duplicate protection for lookup
  const DUP_WINDOW_MS = 2000;

  let rows = [];
  let logEntries = [];
  let lastScan = { key:'', ts:0 };

  // assignment list in scan order
  // {variantId, itemBarcode, sku, title, bin}
  let assignments = [];

  const statusEl = document.getElementById('status');
  const metaEl = document.getElementById('meta');
  const resultEl = document.getElementById('result');
  const logEl = document.getElementById('log');
  const scanCountEl = document.getElementById('scanCount');

  const assignStatusEl = document.getElementById('assignStatus');
  const assignHintEl = document.getElementById('assignHint');
  const assignScanEl = document.getElementById('assignScan');
  const assignBinEl = document.getElementById('assignBin');
  const assignTableEl = document.getElementById('assignTable');
  const assignPreviewEl = document.getElementById('assignPreview');

  const dlShopifyBtn = document.getElementById('dlShopifyBtn');
  const dlLabelsBtn = document.getElementById('dlLabelsBtn');

  function esc(s){
    return String(s ?? '')
      .replace(/&/g,'&amp;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;');
  }
  function setStatus(ok, msg){
    statusEl.innerHTML = `<span class="badge ${ok ? 'good' : 'bad'}">${ok ? 'Loaded' : 'Failed'}</span> ${msg}`;
  }
  function fmtDate(d){ try{ return new Date(d).toLocaleString(); }catch{ return String(d||''); } }
  function setMeta(html){ metaEl.innerHTML = html || ''; }

  function setAssignStatus(kind, text){
    assignStatusEl.className = 'badge ' + (kind || 'warn');
    assignStatusEl.textContent = text;
  }
  function setAssignHint(html){
    assignHintEl.innerHTML = html || '';
  }

  // CSV parsing
  function detectDelimiter(text) {
    const firstLine = (text.split(/\r?\n/).find(l => l.trim() !== '') || '');
    const candidates = [',',';','\t','|'];
    let best = ',', bestCount = -1;
    for (const d of candidates) {
      const c = firstLine.split(d).length;
      if (c > bestCount) { bestCount = c; best = d; }
    }
    return best;
  }
  function parseCSV(text, delimiter) {
    const out = [];
    let i = 0, field = '', row = [], inQuotes = false;
    if (text.charCodeAt(0) === 0xFEFF) text = text.slice(1);

    while (i < text.length) {
      const c = text[i];
      if (c === '"') {
        if (inQuotes && text[i+1] === '"') { field += '"'; i++; }
        else { inQuotes = !inQuotes; }
      } else if (c === delimiter && !inQuotes) {
        row.push(field); field = '';
      } else if ((c === '\n' || c === '\r') && !inQuotes) {
        if (field !== '' || row.length) { row.push(field); out.push(row); row = []; field = ''; }
        if (c === '\r' && text[i+1] === '\n') i++;
      } else {
        field += c;
      }
      i++;
    }
    if (field !== '' || row.length) { row.push(field); out.push(row); }
    return out;
  }
  function toObjects(matrix) {
    if (!matrix.length) return [];
    const headers = (matrix[0] || []).map(h => String(h ?? '').trim());
    const objects = [];
    for (let r = 1; r < matrix.length; r++) {
      const line = matrix[r];
      if (!line || !line.length) continue;
      if (line.join('').trim() === '') continue;
      const obj = {};
      for (let c = 0; c < headers.length; c++) obj[headers[c]] = (line[c] ?? '').trim();
      objects.push(obj);
    }
    return objects;
  }

  function getVariantId(row){
    for(const k of VARIANT_ID_CANDIDATES){
      if(row[k] && String(row[k]).trim()) return String(row[k]).trim();
    }
    return '';
  }

  async function loadCSV(){
    setStatus(false, 'Loading‚Ä¶');
    setMeta('');
    setAssignStatus('warn','Loading CSV‚Ä¶');
    setAssignHint('');
    try{
      const url = CSV_URL + '?v=' + Date.now();
      const res = await fetch(url, { cache: 'no-store' });
      if(!res.ok) throw new Error(`HTTP ${res.status}`);

      const lastModified = res.headers.get('last-modified');
      const etag = res.headers.get('etag');

      const text = await res.text();
      const delim = detectDelimiter(text);
      rows = toObjects(parseCSV(text, delim));

      setStatus(true, `Parsed ${rows.length} rows`);
      setMeta(`
        <div><strong>CSV file:</strong> <code>${esc(CSV_URL)}</code></div>
        <div><strong>CSV Last Updated (server):</strong> ${lastModified ? fmtDate(lastModified) : '<span style="color:#7f1d1d;">Unknown</span>'}</div>
        <div><strong>Loaded at (this device):</strong> ${new Date().toLocaleString()}</div>
        ${etag ? `<div><strong>ETag:</strong> <code class="mono">${esc(etag)}</code></div>` : ''}
      `);

      const sample = rows[0] || {};
      const hasVID = VARIANT_ID_CANDIDATES.some(k => k in sample);
      if(!hasVID){
        setAssignStatus('bad','Missing Variant ID column');
        setAssignHint(`<span class="badge bad">Fix</span> Add <span class="mono">Variant ID</span> to your pickle-data export for bin assignment.`);
      } else if(!(COL_BARCODE in sample)){
        setAssignStatus('bad','Missing Variant Barcode column');
        setAssignHint(`<span class="badge bad">Fix</span> Add <span class="mono">${esc(COL_BARCODE)}</span> to your export so ITEM labels can print the item barcode.`);
      } else {
        setAssignStatus('good','Ready');
        setAssignHint(`<span class="badge good">Flow</span> Scan item ‚Üí (auto to bin if blank) ‚Üí scan bin ‚Üí Enter ‚Üí next item`);
      }
    }catch(e){
      rows = [];
      setStatus(false, `Couldn‚Äôt load <code>${esc(CSV_URL)}</code> ‚Äî ${esc(e.message)}`);
      setMeta(`<div style="color:#7f1d1d;"><strong>Tip:</strong> Open <code>${esc(CSV_URL)}</code> in a browser tab to confirm it exists.</div>`);
      setAssignStatus('bad','CSV load failed');
      setAssignHint('');
    }
  }

  function openCSV(){ window.open(CSV_URL, '_blank', 'noopener'); }

  // ===== Bin Lookup =====
  function renderLog(){
    scanCountEl.textContent = String(logEntries.length);
    logEl.innerHTML = '';
    for(let i=0;i<logEntries.length;i++){
      const e = logEntries[i];
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${esc(new Date(e.ts).toLocaleTimeString())}</td>
        <td class="mono">${esc(e.bin||'')}</td>
        <td class="mono">${esc(e.barcode||'')}</td>
        <td>${esc(e.title||'')}</td>
        <td><button class="btn" type="button" data-i="${i}">Delete</button></td>
      `;
      tr.querySelector('button').addEventListener('click', (ev)=>{
        const idx = Number(ev.currentTarget.getAttribute('data-i'));
        if(Number.isFinite(idx)) { logEntries.splice(idx,1); renderLog(); }
      });
      logEl.appendChild(tr);
    }
  }
  function clearLog(){ logEntries = []; renderLog(); }
  function undoLastScan(){ if(!logEntries.length) return; logEntries.shift(); renderLog(); }

  function showResult(match){
    resultEl.innerHTML = `
      <div class="binBig">${esc(match[COL_BIN]||'‚Äî')}</div>
      <div style="font-weight:1000;margin-top:4px">${esc(match[COL_TITLE]||'')}</div>
      <div class="sub" style="margin-top:6px">
        <strong>Barcode:</strong> <span class="mono">${esc(match[COL_BARCODE]||'')}</span>
        &nbsp; | &nbsp;
        <strong>SKU:</strong> <span class="mono">${esc(match[COL_SKU]||'')}</span>
        &nbsp; | &nbsp;
        <strong>Variant ID:</strong> <span class="mono">${esc(getVariantId(match)||'')}</span>
      </div>
    `;
  }

  function lookup(q){
    if(!rows.length){
      resultEl.innerHTML = `<span class="badge bad">Not ready</span> <span class="sub">Load the CSV first.</span>`;
      return;
    }

    const now = Date.now();
    if (q && lastScan.key === q && (now - lastScan.ts) < DUP_WINDOW_MS){
      lastScan.ts = now;
      return;
    }
    lastScan = { key:q, ts:now };

    const m = rows.find(r =>
      (r[COL_BARCODE] && r[COL_BARCODE]===q) ||
      (r[COL_SKU] && r[COL_SKU]===q)
    );

    if(!m){
      resultEl.innerHTML = `<span class="badge bad">Not found</span> <span class="sub">Try scanning barcode or SKU again.</span>`;
      return;
    }

    showResult(m);

    logEntries.unshift({
      ts: now,
      bin: m[COL_BIN] || '',
      barcode: m[COL_BARCODE] || '',
      title: m[COL_TITLE] || ''
    });
    renderLog();
  }

  document.getElementById('scan').addEventListener('keydown', e=>{
    if(e.key==='Enter'){
      const q = e.target.value.trim();
      e.target.value='';
      lookup(q);
      setTimeout(()=>document.getElementById('scan').focus(), 50);
    }
  });

  // ===== Bin Assignment =====
  function findRowByScan(q){
    if(!rows.length) return null;
    return rows.find(r =>
      (r[COL_BARCODE] && r[COL_BARCODE]===q) ||
      (r[COL_SKU] && r[COL_SKU]===q)
    ) || null;
  }

  function renderAssignments(){
    const has = assignments.length > 0;
    dlShopifyBtn.disabled = !has;
    dlLabelsBtn.disabled = !has;

    assignTableEl.innerHTML = '';
    assignments.forEach((a, i)=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${i+1}</td>
        <td class="mono">${esc(a.variantId)}</td>
        <td class="mono">${esc(a.itemBarcode)}</td>
        <td class="mono">${esc(a.sku)}</td>
        <td>${esc(a.title)}</td>
        <td>
          <input class="cellInput" value="${esc(a.bin||'')}" data-i="${i}" placeholder="(blank OK for Excel)" />
        </td>
        <td><button class="btn" type="button" data-i="${i}">Delete</button></td>
      `;

      tr.querySelector('input').addEventListener('input', (ev)=>{
        const idx = Number(ev.currentTarget.getAttribute('data-i'));
        if(!Number.isFinite(idx)) return;
        assignments[idx].bin = ev.currentTarget.value;
      });

      tr.querySelector('button').addEventListener('click', (ev)=>{
        const idx = Number(ev.currentTarget.getAttribute('data-i'));
        if(Number.isFinite(idx)) { assignments.splice(idx,1); renderAssignments(); }
      });

      assignTableEl.appendChild(tr);
    });

    if(assignments.length){
      const last = assignments[assignments.length-1];
      const binTxt = (last.bin && last.bin.trim()) ? ` ‚Üí <span class="mono">${esc(last.bin)}</span>` : ` ‚Üí <span class="mono">(bin blank)</span>`;
      assignPreviewEl.innerHTML =
        `<span class="badge good">Added</span> <span class="sub">#${assignments.length}: ${esc(last.title)}${binTxt}</span>`;
    } else {
      assignPreviewEl.textContent = '';
    }
  }

  function addAssignmentCore(scanVal, binVal){
    if(!rows.length){
      setAssignStatus('bad','CSV not loaded');
      return false;
    }
    if(!scanVal){
      setAssignStatus('warn','Scan an item first');
      return false;
    }

    const row = findRowByScan(scanVal);
    if(!row){
      setAssignStatus('bad','Item not found in CSV');
      return false;
    }

    const variantId = getVariantId(row);
    if(!variantId){
      setAssignStatus('bad','Variant ID missing for this item');
      return false;
    }

    const itemBarcode = String(row[COL_BARCODE]||'').trim();
    if(!itemBarcode){
      setAssignStatus('bad','Item barcode missing for this item');
      return false;
    }

    assignments.push({
      variantId,
      itemBarcode,
      sku: String(row[COL_SKU]||'').trim(),
      title: String(row[COL_TITLE]||'').trim(),
      bin: binVal || '' // can be blank
    });

    setAssignStatus('good','Ready');
    renderAssignments();
    return true;
  }

  // Button Add uses current field values and clears both after add
  function addAssignmentFromButtons(){
    const scanVal = assignScanEl.value.trim();
    const binVal = assignBinEl.value.trim();
    const ok = addAssignmentCore(scanVal, binVal);
    if(!ok) return;

    assignScanEl.value = '';
    assignBinEl.value = '';
    setAssignHint(`<span class="badge good">OK</span> Scan next item`);
    assignScanEl.focus();
  }

  // Fast flow: item Enter -> if bin empty, focus bin; else add immediately
  assignScanEl.addEventListener('keydown', (e)=>{
    if(e.key === 'Enter'){
      const scanVal = assignScanEl.value.trim();
      if(!scanVal) return;

      if(!assignBinEl.value.trim()){
        e.preventDefault();
        setAssignHint(`<span class="badge warn">Next</span> Scan bin value, then press Enter`);
        assignBinEl.focus();
        return;
      }

      e.preventDefault();
      const ok = addAssignmentCore(scanVal, assignBinEl.value.trim());
      if(!ok) return;

      assignScanEl.value = '';
      assignBinEl.value = '';
      setAssignHint(`<span class="badge good">OK</span> Scan next item`);
      assignScanEl.focus();
    }
  });

  // Bin Enter adds (bin can be blank for Excel sequencing)
  assignBinEl.addEventListener('keydown', (e)=>{
    if(e.key === 'Enter'){
      e.preventDefault();
      const scanVal = assignScanEl.value.trim();
      const binVal = assignBinEl.value.trim(); // can be blank
      const ok = addAssignmentCore(scanVal, binVal);
      if(!ok) return;

      assignScanEl.value = '';
      assignBinEl.value = '';
      setAssignHint(`<span class="badge good">OK</span> Scan next item`);
      assignScanEl.focus();
    }
  });

  function clearAssignments(){
    if(!assignments.length) return;
    const ok = confirm('Clear the entire bin assignment list?');
    if(!ok) return;
    assignments = [];
    renderAssignments();
    setAssignStatus('good','Ready');
    setAssignHint(`<span class="badge good">Ready</span> Scan item`);
    assignPreviewEl.textContent = '';
    assignScanEl.value = '';
    assignBinEl.value = '';
    assignScanEl.focus();
  }

  function csvEscape(s){
    s = String(s ?? '');
    return /[",\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
  }

  // ===== Export 1: Shopify Bin Upload (Variant ID + bin metafield only) =====
  function downloadShopifyBinsCSV(){
    if(!assignments.length) return;

    const H_VARIANT_ID = 'Variant ID';
    const H_BIN = 'Variant Metafield: custom.wh_bin [single_line_text_field]';

    let csv = `${H_VARIANT_ID},${H_BIN}\n`;
    assignments.forEach(a=>{
      csv += `${csvEscape(a.variantId)},${csvEscape(a.bin || '')}\n`;
    });

    const name = makeFilename('SHOPIFY_BIN_UPLOAD');
    downloadText(name, csv);
  }

  // ===== Export 2: Label Print CSV (BIN label then ITEM label alternating) =====
  // Columns: label_type,line1,line2,barcode
  // BIN label: line1=bin, line2=(optional) 'WH', barcode=bin
  // ITEM label: line1=title, line2='SKU: xxx | Bin: yyy', barcode=itemBarcode
  function downloadLabelPrintCSV(){
    if(!assignments.length) return;

    let csv = 'label_type,line1,line2,barcode\n';

    assignments.forEach(a=>{
      const bin = (a.bin || '').trim();

      // BIN LABEL (requires a bin)
      if(bin){
        csv += `BIN,${csvEscape(bin)},${csvEscape('WH')},${csvEscape(bin)}\n`;
      } else {
        // If bin is blank, still print a BIN placeholder row? NO.
        // We skip bin labels when bin is blank because you can't print a location label without a location.
      }

      // ITEM LABEL (always printable)
      const title = a.title || '';
      const skuPart = a.sku ? `SKU: ${a.sku}` : '';
      const binPart = bin ? `Bin: ${bin}` : 'Bin: (blank)';
      const line2 = skuPart ? `${skuPart} | ${binPart}` : binPart;

      csv += `ITEM,${csvEscape(title)},${csvEscape(line2)},${csvEscape(a.itemBarcode)}\n`;
    });

    const name = makeFilename('LABEL_PRINT');
    downloadText(name, csv);
  }

  function makeFilename(prefix){
    const d = new Date();
    const pad = (x)=>String(x).padStart(2,'0');
    return `${prefix}_${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}_${pad(d.getHours())}${pad(d.getMinutes())}.csv`;
  }

  function downloadText(name, text){
    const blob = new Blob([text], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = name;
    a.click();
    URL.revokeObjectURL(url);
  }

  // boot
  loadCSV();

  // service worker
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('../sw.js').catch(()=>{});
    });
  }
</script>

</body>
</html>
