<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Livewell ‚Äì Bin Check Station</title>

<link rel="manifest" href="../manifest.json">
<meta name="theme-color" content="#0f172a">

<style>
  :root{
    --bg:#f7f9fc; --card:#fff; --text:#0f172a; --muted:#475569; --line:#e2e8f0;
    --goodbg:#dcfce7; --good:#166534; --badbg:#fee2e2; --bad:#7f1d1d;
    --warnbg:#fff7ed; --warn:#9a3412;
    --blue:#1d4ed8; --blue2:#2563eb;
    --shadow:0 2px 10px rgba(0,0,0,.06);
  }
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto;background:var(--bg);margin:0;padding:18px;color:var(--text)}
  .wrap{max-width:1100px;margin:0 auto}

  /* NAV */
  .topnav{
    position:sticky; top:0; z-index:50;
    background:#fff;
    border:1px solid var(--line);
    border-radius:14px;
    padding:10px;
    margin-bottom:14px;
    box-shadow:0 2px 10px rgba(0,0,0,.05);
  }
  .topnav .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .topnav a{text-decoration:none}
  .topnav button{
    padding:10px 14px;border-radius:12px;border:1px solid #d1d5db;
    font-weight:900;cursor:pointer;background:#fff;
  }
  .topnav button.active{background:#0f172a;color:#fff;border-color:#0f172a}
  .topnav .spacer{flex:1}
  .small{font-size:12px;color:var(--muted);font-weight:900}

  h1{margin:6px 0 6px;font-size:34px}
  .sub{margin:6px 0 0;color:var(--muted);font-size:13px;line-height:1.35}

  .card{background:var(--card);border-radius:16px;padding:16px;margin-bottom:14px;
    box-shadow:var(--shadow);border:1px solid rgba(226,232,240,.7)}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}

  .btn{padding:10px 12px;border-radius:12px;border:1px solid var(--line);font-weight:900;cursor:pointer;background:#fff}
  .btn:active{transform:translateY(1px)}

  .tag{
    display:inline-block;padding:4px 10px;border-radius:999px;font-size:12px;font-weight:900;
    border:1px solid var(--line);background:#fff;color:#0f172a;
  }
  .tag.good{background:var(--goodbg);color:var(--good);border-color:#86efac}
  .tag.warn{background:var(--warnbg);color:var(--warn);border-color:#fed7aa}
  .tag.bad{background:var(--badbg);color:var(--bad);border-color:#fecaca}

  input.big{
    font-size:28px;padding:14px 14px;width:100%;
    border-radius:14px;border:1px solid #cbd5e1;box-sizing:border-box
  }
  table{width:100%;border-collapse:collapse;font-size:14px}
  th,td{padding:10px;border-bottom:1px solid var(--line);text-align:left;vertical-align:top}
  tbody tr:nth-child(even){background:#f9fafb}
  .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}

  .binBig{font-size:56px;font-weight:1000;margin:6px 0 0;letter-spacing:1px}
  code{background:#f3f4f6;padding:2px 6px;border-radius:8px}

  .kv{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
  .pill{border:1px solid var(--line);background:#fff;border-radius:999px;padding:5px 10px;font-size:12px;font-weight:900;color:#0f172a}
  .muted{color:var(--muted)}
</style>
</head>

<body>
<div class="wrap">

  <!-- NAV -->
  <div class="topnav">
    <div class="row">
      <a href="../index.html"><button>üè† Home</button></a>
      <button class="active">üìç Bin Check Station</button>
      <div class="spacer"></div>
      <div class="small">Warehouse Kiosk</div>
    </div>
  </div>

  <div class="card">
    <h1>BIN CHECK STATION</h1>
    <p class="sub">
      <strong>Scan Item ‚Üí</strong> shows the bin it should be in.<br>
      <strong>Scan Bin ‚Üí</strong> shows items the system says belong in that bin.
      <br><span class="muted">Data source: <code>pickle-data.csv</code></span>
    </p>

    <div class="row" style="margin-top:12px">
      <span id="csvStatus" class="tag warn">CSV: Loading‚Ä¶</span>
      <span id="modeBadge" class="tag warn">MODE: ‚Äî</span>
      <div style="flex:1"></div>
      <button class="btn" type="button" onclick="loadCSV()">Reload</button>
      <button class="btn" type="button" onclick="clearLog()">Clear Log</button>
    </div>

    <div style="margin-top:14px">
      <div class="sub"><strong>Scan BIN label</strong> (bin code) OR <strong>scan product</strong> (barcode/SKU) then press Enter</div>
      <input id="scan" class="big" placeholder="Scan BIN or product barcode/SKU + Enter" autocomplete="off" inputmode="none" autofocus>
      <div id="result" style="margin-top:12px"></div>
    </div>
  </div>

  <div class="card">
    <div class="row" style="justify-content:space-between">
      <div>
        <div style="font-weight:1000;font-size:16px">Scan Log</div>
        <div class="sub">Last scans (this session only).</div>
      </div>
      <div class="sub">Scans: <strong id="scanCount">0</strong></div>
    </div>

    <div style="margin-top:10px; overflow:auto; max-height:52vh">
      <table>
        <thead>
          <tr><th>Time</th><th>Type</th><th>Bin</th><th>Barcode</th><th>Title / Count</th><th></th></tr>
        </thead>
        <tbody id="log"></tbody>
      </table>
    </div>
  </div>

</div>

<script>
/** =========================
 * CONFIG
 * ========================= */
const CSV_URL = '../pickle-data.csv';

// pickle-data headers
const COL_BARCODE = 'Variant Barcode';
const COL_SKU = 'Variant SKU';
const COL_TITLE = 'Title';
const COL_BIN = 'Variant Metafield: custom.wh_bin [single_line_text_field]';

// Optional: Warehouse on-hand column (will show totals if present)
const COL_WH_ONHAND = 'Inventory Available: Warehouse-66';

// Variant ID candidates (for display)
const VARIANT_ID_CANDIDATES = [
  'Variant ID','Variant Id','variant_id','variant id','VariantID',
  'Variant: ID','Variant: Id'
];

// Duplicate scan guard (scanner double-fire)
const DUP_WINDOW_MS = 350;

let rows = [];
let logEntries = [];
let lastScan = { key:'', ts:0 };

// Elements
const resultEl = document.getElementById('result');
const logEl = document.getElementById('log');
const scanCountEl = document.getElementById('scanCount');
const csvStatusEl = document.getElementById('csvStatus');
const modeBadgeEl = document.getElementById('modeBadge');

/** =========================
 * UI helpers
 * ========================= */
function esc(s){
  return String(s ?? '')
    .replace(/&/g,'&amp;')
    .replace(/</g,'&lt;')
    .replace(/>/g,'&gt;')
    .replace(/"/g,'&quot;');
}
function setTag(el, kind, text){
  el.className = 'tag ' + (kind || 'warn');
  el.textContent = text;
}
function nInt(v){
  const s = String(v ?? '').trim();
  if(!s) return 0;
  const num = Number(s);
  return Number.isFinite(num) ? Math.floor(num) : 0;
}
function getVariantId(row){
  for(const k of VARIANT_ID_CANDIDATES){
    if(row[k] && String(row[k]).trim()) return String(row[k]).trim();
  }
  return '';
}

/** =========================
 * CSV parsing (robust; supports commas + quotes)
 * ========================= */
function detectDelimiter(text) {
  const firstLine = (text.split(/\r?\n/).find(l => l.trim() !== '') || '');
  const candidates = [',',';','\t','|'];
  let best = ',', bestCount = -1;
  for (const d of candidates) {
    const c = firstLine.split(d).length;
    if (c > bestCount) { bestCount = c; best = d; }
  }
  return best;
}
function parseCSV(text, delimiter) {
  const out = [];
  let i = 0, field = '', row = [], inQuotes = false;
  if (text.charCodeAt(0) === 0xFEFF) text = text.slice(1);

  while (i < text.length) {
    const c = text[i];
    if (c === '"') {
      if (inQuotes && text[i+1] === '"') { field += '"'; i++; }
      else { inQuotes = !inQuotes; }
    } else if (c === delimiter && !inQuotes) {
      row.push(field); field = '';
    } else if ((c === '\n' || c === '\r') && !inQuotes) {
      if (field !== '' || row.length) { row.push(field); out.push(row); row = []; field = ''; }
      if (c === '\r' && text[i+1] === '\n') i++;
    } else {
      field += c;
    }
    i++;
  }
  if (field !== '' || row.length) { row.push(field); out.push(row); }
  return out;
}
function toObjects(matrix) {
  if (!matrix.length) return [];
  const headers = (matrix[0] || []).map(h => String(h ?? '').trim());
  const objects = [];
  for (let r = 1; r < matrix.length; r++) {
    const line = matrix[r];
    if (!line || !line.length) continue;
    if (line.join('').trim() === '') continue;
    const obj = {};
    for (let c = 0; c < headers.length; c++) obj[headers[c]] = (line[c] ?? '').trim();
    objects.push(obj);
  }
  return objects;
}

/** =========================
 * Load CSV
 * ========================= */
async function loadCSV(){
  setTag(csvStatusEl, 'warn', 'CSV: Loading‚Ä¶');
  setTag(modeBadgeEl, 'warn', 'MODE: ‚Äî');
  resultEl.innerHTML = '';
  try{
    const url = CSV_URL + '?v=' + Date.now();
    const res = await fetch(url, { cache: 'no-store' });
    if(!res.ok) throw new Error(`HTTP ${res.status}`);

    const text = await res.text();
    const delim = detectDelimiter(text);
    rows = toObjects(parseCSV(text, delim));

    setTag(csvStatusEl, 'good', `CSV: Loaded (${rows.length} rows)`);
  }catch(e){
    rows = [];
    setTag(csvStatusEl, 'bad', 'CSV: FAILED');
    resultEl.innerHTML = `<span class="tag bad">CSV load failed</span> <span class="sub">${esc(e.message)}</span>`;
  }
}

/** =========================
 * Log rendering
 * ========================= */
function renderLog(){
  scanCountEl.textContent = String(logEntries.length);
  logEl.innerHTML = '';
  for(let i=0;i<logEntries.length;i++){
    const e = logEntries[i];
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${esc(new Date(e.ts).toLocaleTimeString())}</td>
      <td class="mono">${esc(e.type||'')}</td>
      <td class="mono">${esc(e.bin||'')}</td>
      <td class="mono">${esc(e.barcode||'')}</td>
      <td>${esc(e.title||'')}</td>
      <td><button class="btn" type="button" data-i="${i}">Delete</button></td>
    `;
    tr.querySelector('button').addEventListener('click', (ev)=>{
      const idx = Number(ev.currentTarget.getAttribute('data-i'));
      if(Number.isFinite(idx)) { logEntries.splice(idx,1); renderLog(); }
    });
    logEl.appendChild(tr);
  }
}
function clearLog(){ logEntries = []; renderLog(); }

/** =========================
 * Result rendering
 * ========================= */
function showProductResult(match){
  const vid = getVariantId(match) || '';
  const bin = (match[COL_BIN] || '').trim() || '‚Äî';
  const wh = (COL_WH_ONHAND in match) ? nInt(match[COL_WH_ONHAND]) : null;

  setTag(modeBadgeEl, 'good', 'MODE: PRODUCT');

  resultEl.innerHTML = `
    <div class="binBig">${esc(bin)}</div>
    <div style="font-weight:1000;margin-top:4px">${esc(match[COL_TITLE]||'')}</div>

    <div class="kv">
      <div class="pill"><strong>SKU:</strong> <span class="mono">${esc(match[COL_SKU]||'')}</span></div>
      <div class="pill"><strong>Barcode:</strong> <span class="mono">${esc(match[COL_BARCODE]||'')}</span></div>
      ${vid ? `<div class="pill"><strong>Variant ID:</strong> <span class="mono">${esc(vid)}</span></div>` : ``}
      ${wh !== null ? `<div class="pill"><strong>WH On Hand:</strong> <span class="mono">${esc(wh)}</span></div>` : ``}
    </div>

    <div class="sub" style="margin-top:10px">
      <strong>Meaning:</strong> This product should be in bin <span class="mono">${esc(bin)}</span>.
    </div>
  `;
}

function showBinResult(binCode, matches){
  setTag(modeBadgeEl, 'warn', 'MODE: BIN');

  const list = [...matches].sort((a,b)=>{
    const ta = (a[COL_TITLE]||'').toLowerCase();
    const tb = (b[COL_TITLE]||'').toLowerCase();
    return ta.localeCompare(tb);
  });

  const hasWH = list.length ? (COL_WH_ONHAND in list[0]) : false;
  let totalWH = 0;
  if(hasWH){
    list.forEach(r=> totalWH += nInt(r[COL_WH_ONHAND]));
  }

  let html = `
    <div class="binBig">${esc(binCode)}</div>
    <div class="sub" style="margin-top:6px">
      <strong>Meaning:</strong> These are the items the system says are assigned to this bin.
    </div>
    <div class="kv">
      <div class="pill"><strong>Items:</strong> <span class="mono">${esc(list.length)}</span></div>
      ${hasWH ? `<div class="pill"><strong>Total WH On Hand:</strong> <span class="mono">${esc(totalWH)}</span></div>` : ``}
    </div>

    <div style="margin-top:12px; overflow:auto; max-height:45vh">
      <table>
        <thead>
          <tr>
            <th>Title</th>
            <th>SKU</th>
            <th>Barcode</th>
            ${hasWH ? `<th>WH On Hand</th>` : ``}
          </tr>
        </thead>
        <tbody>
  `;

  for(const r of list){
    const wh = hasWH ? nInt(r[COL_WH_ONHAND]) : '';
    html += `
      <tr>
        <td>${esc(r[COL_TITLE]||'')}</td>
        <td class="mono">${esc(r[COL_SKU]||'')}</td>
        <td class="mono">${esc(r[COL_BARCODE]||'')}</td>
        ${hasWH ? `<td class="mono">${esc(wh)}</td>` : ``}
      </tr>
    `;
  }

  html += `
        </tbody>
      </table>
    </div>
  `;

  resultEl.innerHTML = html;
}

/** =========================
 * Smart lookup: BIN or PRODUCT
 * ========================= */
function smartLookup(q){
  if(!rows.length){
    resultEl.innerHTML = `<span class="tag bad">Not ready</span> <span class="sub">CSV not loaded.</span>`;
    setTag(modeBadgeEl, 'warn', 'MODE: ‚Äî');
    return;
  }

  const now = Date.now();
  if (q && lastScan.key === q && (now - lastScan.ts) < DUP_WINDOW_MS){
    lastScan.ts = now;
    return;
  }
  lastScan = { key:q, ts:now };

  // 1) BIN MODE (exact bin match)
  const binMatches = rows.filter(r => (r[COL_BIN] || '').trim() === q);
  if(binMatches.length){
    showBinResult(q, binMatches);
    logEntries.unshift({
      ts: now,
      type: 'BIN',
      bin: q,
      barcode: '',
      title: `${binMatches.length} items`
    });
    renderLog();
    return;
  }

  // 2) PRODUCT MODE (barcode or sku)
  const m = rows.find(r =>
    (r[COL_BARCODE] && String(r[COL_BARCODE]).trim() === q) ||
    (r[COL_SKU] && String(r[COL_SKU]).trim() === q)
  );

  if(!m){
    setTag(modeBadgeEl, 'bad', 'MODE: NOT FOUND');
    resultEl.innerHTML = `<span class="tag bad">Not found</span> <span class="sub">Scan a BIN code, barcode, or SKU again.</span>`;
    return;
  }

  showProductResult(m);
  logEntries.unshift({
    ts: now,
    type: 'PRODUCT',
    bin: (m[COL_BIN] || '').trim(),
    barcode: (m[COL_BARCODE] || '').trim(),
    title: (m[COL_TITLE] || '').trim()
  });
  renderLog();
}

/** Scan input handler */
document.getElementById('scan').addEventListener('keydown', e=>{
  if(e.key === 'Enter'){
    const q = e.target.value.trim();
    e.target.value = '';
    if(!q) return;
    smartLookup(q);
    setTimeout(()=>document.getElementById('scan').focus(), 25);
  }
});

/** boot */
loadCSV();
renderLog();
</script>

</body>
</html>
